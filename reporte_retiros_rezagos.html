<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Report Scorecard Retiros y Rezagos</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #fff;
      color: #333;
      margin: 0;
      padding: 24px;
      line-height: 1.5;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 {
      color: #ffe600;
      background: #3483fa;
      margin: -24px -24px 24px -24px;
      padding: 20px 24px;
      font-size: 1.5rem;
      font-weight: 700;
    }
    h2 {
      color: #3483fa;
      font-size: 1.2rem;
      margin-top: 32px;
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 2px solid #ffe600;
    }
    /* Filtros */
    .filtros {
      background: #f5f5f5;
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      align-items: end;
    }
    .filtros label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: #666;
      margin-bottom: 6px;
    }
    .filtros select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
      background: #fff;
    }
    .filtros select:focus {
      outline: none;
      border-color: #3483fa;
      box-shadow: 0 0 0 2px rgba(52, 131, 250, 0.2);
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary {
      background: #3483fa;
      color: #fff;
    }
    .btn-primary:hover { background: #2968c8; }
    .btn-secondary {
      background: #fff;
      color: #3483fa;
      border: 1px solid #3483fa;
    }
    .btn-secondary:hover { background: #f0f7ff; }
    /* KPIs destacados */
    .kpi {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }
    .kpi-card {
      background: #f5f5f5;
      border-left: 4px solid #3483fa;
      padding: 16px 20px;
      min-width: 140px;
      border-radius: 4px;
    }
    .kpi-card .value { font-size: 1.75rem; font-weight: 700; color: #333; }
    .kpi-card .label { font-size: 0.85rem; color: #666; margin-top: 4px; }
    /* Tabla principal */
    .tabla-wrap { overflow-x: auto; margin-bottom: 24px; max-width: 100%; }
    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      font-size: 0.85rem;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
      border-radius: 4px;
      overflow: hidden;
    }
    th, td { padding: 8px 6px; text-align: center; }
    th {
      background: #3483fa;
      color: #fff;
      font-weight: 600;
    }
    th.th-period { white-space: normal; line-height: 1.2; text-align: center; word-break: break-word; }
    th.num, td.num { text-align: center; font-variant-numeric: tabular-nums; }
    /* Resumen por Site: 6 columnas */
    #tabla-kpis th:nth-child(1), #tabla-kpis td:nth-child(1) { width: 10%; }
    #tabla-kpis th:nth-child(2), #tabla-kpis th:nth-child(3), #tabla-kpis th:nth-child(4),
    #tabla-kpis td:nth-child(2), #tabla-kpis td:nth-child(3), #tabla-kpis td:nth-child(4) { width: 18%; }
    #tabla-kpis th:nth-child(5), #tabla-kpis th:nth-child(6), #tabla-kpis td:nth-child(5), #tabla-kpis td:nth-child(6) { width: 14%; }
    /* Detalle por FC: 7 columnas */
    #tabla-fc th:nth-child(1), #tabla-fc td:nth-child(1) { width: 8%; }
    #tabla-fc th:nth-child(2), #tabla-fc td:nth-child(2) { width: 7%; }
    #tabla-fc th:nth-child(3), #tabla-fc th:nth-child(4), #tabla-fc th:nth-child(5),
    #tabla-fc td:nth-child(3), #tabla-fc td:nth-child(4), #tabla-fc td:nth-child(5) { width: 17%; }
    #tabla-fc th:nth-child(6), #tabla-fc th:nth-child(7), #tabla-fc td:nth-child(6), #tabla-fc td:nth-child(7) { width: 13%; }
    tr:nth-child(even) { background: #f9f9f9; }
    tr.row-header th { background: #3483fa; color: #fff; font-weight: 700; }
    tr:hover { background: #f0f7ff; }
    tr.kpi-group { font-weight: 600; background: #e8f0fe; }
    tr.total-row { font-weight: 700; background: #e8f0fe; }
    .delta-pos { color: #00a650; }
    .delta-neg { color: #f23d4f; }
    .note { font-size: 0.9rem; color: #666; margin-bottom: 16px; }
    .footer {
      margin-top: 40px;
      padding-top: 16px;
      border-top: 1px solid #eee;
      font-size: 0.8rem;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Daily Report Scorecard Retiros y Rezagos</h1>
    <p class="note">Datos desde <strong>01/10/2025</strong> hasta el <strong id="fecha-hoy-nota"></strong> (fecha de actualización). Períodos: Pre (01 Oct-30 Nov), Pre (01-31 Dic), Post (19 Ene - <span id="fecha-fin-post-nota"></span>).</p>

    <!-- Filtros: Año, Site, FC -->
    <h2>Filtros</h2>
    <div class="filtros">
      <div>
        <label for="anio">Año</label>
        <select id="anio">
          <option value="Todos">Todos</option>
          <option value="2025">2025</option>
          <option value="2026">2026</option>
        </select>
      </div>
      <div>
        <label for="site">Site / País</label>
        <select id="site">
          <option value="">Todos</option>
          <option value="MLB">MLB</option>
          <option value="MLM">MLM</option>
          <option value="MLA">MLA</option>
          <option value="MLC">MLC</option>
          <option value="MCO">MCO</option>
        </select>
      </div>
      <div>
        <label for="fc">FC</label>
        <select id="fc"><option value="">Todos</option></select>
      </div>
      <div style="display: flex; gap: 8px;">
        <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">Aplicar</button>
        <button type="button" class="btn btn-secondary" onclick="descargarCSV()">Descargar CSV</button>
      </div>
    </div>

    <h2>Resumen KPIs</h2>
    <p class="note">Todo el dashboard (tarjetas, Resumen por Site y Detalle por FC) cambia según los filtros Año, Site y FC.</p>
    <div class="kpi" id="kpi-cards">
      <div class="kpi-card">
        <div class="value" id="kpi-picking">60,8</div>
        <div class="label" id="kpi-picking-label">Productividad efectiva (Picking)</div>
      </div>
      <div class="kpi-card">
        <div class="value" id="kpi-packing">139,7</div>
        <div class="label" id="kpi-packing-label">Productividad efectiva (Packing)</div>
      </div>
      <div class="kpi-card">
        <div class="value" id="kpi-tote">12,2</div>
        <div class="label" id="kpi-tote-label">Piezas por Tote (#unidades/#totes)</div>
      </div>
      <div class="kpi-card">
        <div class="value" id="kpi-share">35,4%</div>
        <div class="label" id="kpi-share-label">Share Retiros</div>
      </div>
    </div>

    <h2>Resumen por Site</h2>
    <div class="tabla-wrap">
      <table id="tabla-kpis">
        <thead id="tabla-kpis-thead"><tr><th>Site</th></tr></thead>
        <tbody id="tabla-kpis-body"></tbody>
      </table>
    </div>

    <h2>Detalle por FC (centro logístico)</h2>
    <div class="tabla-wrap">
      <table id="tabla-fc">
        <thead id="tabla-fc-thead"><tr><th>Site</th><th>FC</th></tr></thead>
        <tbody id="tabla-fc-body"></tbody>
      </table>
    </div>

    <h2>Qué incluye Pre y Post implementación</h2>
    <div class="note" style="margin-bottom: 24px;">
      <strong>Pre-implementación (p1: 01 Oct–30 Nov 2025; p2: 01–31 Dic 2025):</strong> solo procesos <em>withdrawals</em> (retiros).<br>
      <strong>Post-implementación (p3: 19 Ene – <span id="fecha-fin-post-texto"></span>):</strong> desde el <strong>19/01/2026</strong> se suman los procesos <em>disposal</em>. La fecha de fin es la última actualización del reporte (diaria). Es decir: Picking = picking withdrawal + picking disposal; Packing = packing withdrawal + packing disposal (cuando aplique). Misma fórmula de productividad en todos los casos.
    </div>

    <h2>Fuentes de datos</h2>
    <div class="footer">
      <strong>Tablas principales (BigQuery, proyecto meli-bi-data):</strong><br>
      • <strong>SBOX_REVERSA.REMOVALS_PRODUCTIVITY_AREA</strong> — Productividad efectiva (Picking y Packing), WAREHOUSE = FC.<br>
      • <strong>SBOX_REVERSA.RETURNS_NP_OUT</strong> — Share Retiros, LOGISTIC_CENTER_ID = FC.<br>
      • <strong>WHOWNER.LK_SOT_PICKING_MAIN_TABLE</strong> — Piezas por Tote: SUM(UNIT_QTY_PICKED)/SUM(TOTES_PER_CART_USED).<br>
      Datos desde 01/10/2025 hasta el <span id="fecha-hoy-footer"></span> (actualización diaria).
    </div>
  </div>

  <script>
    // Picking: datos reales BigQuery RETURNS_NP_OUT. Pre: picking_withdrawals; Post: picking_withdrawals + picking_disposal (impl. 19/01/2026).
    var datosPickingFC = [["MCO","COCU02",110.2,113.4,101.1,-8.2,-10.8],["MLA","ARBA01",56.4,58.3,49.1,-12.9,-15.8],["MLA","ARBA02",11.8,48.3,32.6,176.5,-32.5],["MLA","ARBA04",39.9,61.3,30.1,-24.6,-50.8],["MLB","BRBA01",53.4,50.5,57.9,8.4,14.7],["MLB","BRBA02",19.8,34,27.5,39.3,-19],["MLB","BRDF01",58.7,50.4,70,19.2,39],["MLB","BRMG01",37.7,42.7,58.5,55,36.8],["MLB","BRMG02",64.2,129.6,64.4,0.4,-50.3],["MLB","BRMG03",34.1,21.8,46,34.8,111.3],["MLB","BRMG04",0,0,55.4,null,null],["MLB","BRPE01",61.3,60.4,56.3,-8.1,-6.8],["MLB","BRPR01",30.9,32.2,40.8,31.9,26.9],["MLB","BRRC01",101.4,93.9,115.2,13.5,22.7],["MLB","BRRC02",43,44.8,72.3,68.3,61.2],["MLB","BRRC03",67.6,75.3,108.8,60.9,44.5],["MLB","BRRJ02",48.2,49.4,51.5,6.8,4.2],["MLB","BRRS01",74,67.8,63.1,-14.7,-6.9],["MLB","BRSC02",59.9,63,59.2,-1.1,-6],["MLB","BRSP02",34.3,36.6,41.5,20.8,13.4],["MLB","BRSP04",52.7,69.7,66.7,26.6,-4.3],["MLB","BRSP06",97.9,94.7,86.9,-11.2,-8.3],["MLB","BRSP09",27.4,12.9,28.2,2.8,119.4],["MLB","BRSP10",44.3,52.3,39,-11.9,-25.4],["MLB","BRSP11",62.3,49.1,44.9,-27.8,-8.5],["MLB","BRSP15",60.9,59.1,59.9,-1.8,1.2],["MLB","BRSP18",68.2,68.6,77.9,14.2,13.6],["MLB","BRSP19",72.7,72.1,79.5,9.3,10.2],["MLB","BRSP24",41.2,36.9,48.4,17.6,31.1],["MLB","BRSP25",28.6,53.1,90.7,217.7,70.7],["MLB","SSP21",0,null,null,null,null],["MLC","CLBB01",45,52.2,50,11.3,-4.2],["MLC","CLRM03",91.2,85.9,91.3,0.2,6.3],["MLM","MXCD02",60.9,64.6,79.5,30.6,23],["MLM","MXCD05",39.2,40.1,40,2.3,0],["MLM","MXCD06",165.1,143.2,153.1,-7.2,6.9],["MLM","MXCD07",78,62.4,77.2,-1,23.7],["MLM","MXCD08",2.9,11.4,24.5,731.2,114.8],["MLM","MXCD09",43.6,35.7,41.5,-5,16.2],["MLM","MXCD10",79.6,78.4,108,35.7,37.8],["MLM","MXCD11",64.5,65.4,65.6,1.7,0.4],["MLM","MXCD12",30.7,23.9,23.7,-22.9,-0.9],["MLM","MXCD14",null,null,2.6,null,null],["MLM","MXGT01",58.8,48.5,62.4,6.2,28.6],["MLM","MXJC01",78.6,68.6,75.3,-4.2,9.8],["MLM","MXNL01",60.6,56.8,75.8,25.1,33.3],["MLM","MXRC03",115.9,77.1,90.1,-22.3,16.8],["MLM","MXSO01",41.9,67,76,81.4,13.4],["MLM","MXYU01",63.2,65.6,68.2,7.8,3.9],["MLM","USTX01",218.3,140.3,186.9,-14.4,33.2]];
    // Packing: datos reales BigQuery RETURNS_NP_OUT. Pre: packing_withdrawals; Post: + packing_disposal (impl. 19/01/2026).
    var datosPackingFC = [["MCO","COCU02",189.1,171.7,145.3,-23.2,-15.4],["MLA","ARBA01",102,102.2,90.2,-11.6,-11.7],["MLA","ARBA02",25,27.8,28,11.7,0.7],["MLA","ARBA04",32.1,42.8,71.6,123,67.3],["MLB","BRBA01",174,151.2,170.2,-2.2,12.6],["MLB","BRBA02",55.9,60.2,46.8,-16.2,-22.3],["MLB","BRDF01",93.6,92,67.3,-28.1,-26.8],["MLB","BRMG01",63.9,68.5,88.1,37.8,28.5],["MLB","BRMG02",163.8,226.2,137.4,-16.1,-39.2],["MLB","BRMG03",57.4,46.4,52.4,-8.7,13],["MLB","BRMG04",0,null,21.9,null,null],["MLB","BRPE01",134.5,115.6,133.2,-0.9,15.2],["MLB","BRPR01",51.4,61.1,107.5,109.2,75.9],["MLB","BRRC01",141.2,166.1,127.9,-9.4,-23],["MLB","BRRC02",29.3,41.6,64.9,121.4,55.8],["MLB","BRRC03",51.4,58.6,62.3,21.3,6.5],["MLB","BRRJ02",151.1,124.8,161.8,7.1,29.6],["MLB","BRRS01",139.9,126.3,148.6,6.3,17.7],["MLB","BRSC02",127.6,117.1,124.1,-2.8,6],["MLB","BRSP02",86.1,92.2,100.3,16.4,8.7],["MLB","BRSP04",236.9,211.4,258,8.9,22],["MLB","BRSP06",174.3,161,183.2,5.1,13.8],["MLB","BRSP09",143.2,430.2,498.7,248.3,15.9],["MLB","BRSP10",110.9,78.4,85.8,-22.6,9.5],["MLB","BRSP11",122.5,59.3,129.6,5.7,118.5],["MLB","BRSP14",217.9,201.9,200.8,-7.8,-0.5],["MLB","BRSP15",198.7,158,203.7,2.5,28.9],["MLB","BRSP18",176.8,171.4,205.1,16,19.6],["MLB","BRSP19",168.2,160.9,202.2,20.2,25.7],["MLB","BRSP24",43.8,64.5,80.2,83.3,24.4],["MLB","BRSP25",45,102.9,129.2,187,25.5],["MLB","CAMPINAS",null,0,null,null,null],["MLC","CLBB01",37.6,44.3,51.3,36.4,15.8],["MLC","CLRM03",165.8,172,187,12.8,8.7],["MLM","MXCD02",162.5,134.2,185.5,14.2,38.3],["MLM","MXCD05",53.4,47.6,53.7,0.6,12.9],["MLM","MXCD06",189.1,186.4,252.3,33.4,35.4],["MLM","MXCD07",229,173,214.6,-6.3,24.1],["MLM","MXCD08",45.2,84.6,99.4,120,17.4],["MLM","MXCD09",92.7,68.9,95.8,3.3,38.9],["MLM","MXCD10",281.3,248.6,343.9,22.3,38.3],["MLM","MXCD11",110.6,88.7,123.8,11.9,39.5],["MLM","MXCD12",59.7,54.6,74,23.9,35.4],["MLM","MXCD14",null,null,0.7,null,null],["MLM","MXGT01",161.9,146.4,160,-1.2,9.3],["MLM","MXJC01",254.6,232.3,284.3,11.7,22.4],["MLM","MXNL01",187.9,174,195.8,4.2,12.5],["MLM","MXRC03",161.1,112.1,127.7,-20.7,13.9],["MLM","MXRC04",108.8,null,null,null,null],["MLM","MXSO01",36.3,79.5,82.7,127.4,4],["MLM","MXYU01",168.8,141.3,153.2,-9.2,8.4],["MLM","USTX01",130.7,145.6,113.7,-13,-21.9]];
    var datosShareFC = [["MCO","COCU02",92.7,95.3,92.2,-0.5,-3.3],["MLA","ARBA01",89.4,93.5,90.6,1.3,-2.9],["MLA","ARBA02",89.4,89.7,34.2,-61.7,-61.9],["MLA","ARBA04",89.4,89.7,90.9,1.7,1.3],["MLB","BRBA01",72.4,79.5,64.8,-10.6,-18.5],["MLB","BRMG01",72.4,56.4,56.1,-22.5,-0.5],["MLB","BRSC02",72.4,78,73,0.8,-6.4],["MLB","BRSP02",72.4,65.3,75.2,3.9,15.2],["MLB","BRSP19",72.4,83,55.1,-23.9,-33.6],["MLC","CLRM03",78.9,75.2,80.1,1.5,6.5],["MLM","MXCD02",59.5,58.1,59.5,0,-2.2],["MLM","MXJC01",59.5,82.1,70.3,18.2,-14.3],["MLM","MXYU01",59.5,76.6,63.5,6.7,-17.1]];
    // Piezas por Tote = SUM(UNIT_QTY_PICKED)/SUM(TOTES_PER_CART_USED). Fuente: WHOWNER.LK_SOT_PICKING_MAIN_TABLE.
    var datosToteFC = [["MCO","COCU02",9.3,9.1,10,7.8,9.5],["MLA","ARBA01",9,9.1,9.3,3.1,1.8],["MLA","ARBA02",5.1,1.9,3.8,-26.7,99],["MLA","ARBA04",15.8,20.2,16.7,6.3,-17.1],["MLB","BRBA01",11.5,12,12.5,8.2,3.8],["MLB","BRBA02",31.9,31.8,30.4,-4.7,-4.5],["MLB","BRDF01",11.2,12.5,12.2,8,-2.4],["MLB","BRMG01",14.2,13.6,14.3,1,5],["MLB","BRMG02",12.5,13.2,12.2,-2.2,-6.9],["MLB","BRMG03",12.9,16.5,15,16.4,-9.1],["MLB","BRMG04",20.2,19.5,15.9,-21.3,-18.2],["MLB","BRPE01",11.9,11.3,11.9,-0.2,4.9],["MLB","BRPR01",11.5,13.2,13.3,16.5,1.1],["MLB","BRRC01",11.6,8.5,11.1,-3.9,30.2],["MLB","BRRC02",6.5,6.3,7.8,21.6,23.7],["MLB","BRRC03",10.2,10.8,17.2,68.3,58.6],["MLB","BRRJ02",12.3,12.7,12.2,-1.6,-4.4],["MLB","BRRS01",11.1,11.7,11.5,3.6,-2.1],["MLB","BRSC02",11,11.2,11.6,5.4,4.1],["MLB","BRSP02",12.6,12.5,11.9,-4.9,-4.5],["MLB","BRSP04",11.9,12.2,12.5,5.1,2.5],["MLB","BRSP06",11.8,12.4,12.3,4.4,-0.6],["MLB","BRSP09",4.4,5.7,5.4,22.7,-6.1],["MLB","BRSP10",35.6,33.5,36.6,3.1,9.5],["MLB","BRSP11",30.7,27.8,31.2,1.8,12.4],["MLB","BRSP14",14.1,13.7,14.1,-0.5,2.9],["MLB","BRSP15",12.6,12.2,12.2,-2.8,0.6],["MLB","BRSP18",12.1,11.4,13,7.1,13.7],["MLB","BRSP19",12.3,11.5,12.7,3.5,11],["MLB","BRSP24",11.1,13.6,11.9,7.4,-12.2],["MLB","BRSP25",12.7,13.1,13.7,7.5,4.6],["MLC","CLBB01",4.4,5.3,4.4,-0.5,-17.6],["MLC","CLRM03",11.5,11.8,11.9,3.7,0.6],["MLM","MXCD02",10.6,10.2,10.2,-3.7,0.1],["MLM","MXCD05",17.7,23.8,25.2,42.3,5.8],["MLM","MXCD06",14.8,14,15,1.5,7.3],["MLM","MXCD07",11.2,12,12,6.6,-0.3],["MLM","MXCD08",5.6,7.9,8.8,57.3,11.2],["MLM","MXCD09",11.3,10.3,10.5,-7,2],["MLM","MXCD10",11,10.7,11.3,2.9,4.9],["MLM","MXCD11",20.7,27.1,27.4,32.3,1],["MLM","MXCD12",19.5,26.4,25.5,30.3,-3.8],["MLM","MXCD14",null,null,5.4,null,null],["MLM","MXGT01",10.9,11.2,11.2,3.4,0.6],["MLM","MXJC01",12.1,11.9,12.6,4.5,6.3],["MLM","MXNL01",14,13.9,14.2,1.7,2.7],["MLM","MXRC03",10.1,14.1,10.2,0.8,-28.3],["MLM","MXSO01",9.6,10.5,9.8,2.2,-6.6],["MLM","MXYU01",11.8,12,12.3,4,2.1]];
    var resumenSite = { MLB: { picking: 55.5, packing: 133.8, tote: 12.7, share: 36.6 }, MLM: { picking: 68.4, packing: 158.3, tote: 12.1, share: 34.9 }, MLA: { picking: 48.9, packing: 89.7, tote: 9.3, share: 34.2 }, MLC: { picking: 91.3, packing: 186.7, tote: 11.6, share: 28.5 }, MCO: { picking: 101.1, packing: 145.3, tote: 10, share: 26.0 }, Total: { picking: 60.8, packing: 139.7, tote: 12.2, share: 35.4 } };
    var resumenSiteFull = { MLB: { picking: [47.1,52.6,55.5], packing: [120.5,119.5,133.8], tote: [12.4,12.6,12.7], share: [72.4,69.1,36.6] }, MLM: { picking: [61.6,57,68.4], packing: [147.5,121.9,158.3], tote: [11.9,11.7,12.1], share: [59.5,51.5,34.9] }, MLA: { picking: [56.4,58.3,48.9], packing: [101.8,101.4,89.7], tote: [9,9.2,9.3], share: [89.4,89.7,34.2] }, MLC: { picking: [91.1,85.9,91.3], packing: [165.5,171.5,186.7], tote: [11.4,11.7,11.6], share: [78.9,74.1,28.5] }, MCO: { picking: [110.2,113.4,101.1], packing: [189.1,171.7,145.3], tote: [9.3,9.1,10], share: [92.7,95,26] }, Total: { picking: [53.8,56,60.8], packing: [130.1,120.9,139.7], tote: [11.9,11.9,12.2], share: [68.9,63.7,35.4] } };
    var SITES_ORDER = ['MLB','MLM','MLA','MLC','MCO','Total'];
    var MESES_CORTOS = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    function fechaFinPostLabel() {
      var d = new Date();
      return d.getDate() + ' ' + MESES_CORTOS[d.getMonth()] + ' ' + d.getFullYear();
    }
    function fmt(v) { return v == null || v === '' ? '—' : Number(v).toLocaleString('es-AR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }); }
    function fmtPct(v) { return v == null || v === '' ? '—' : fmt(v) + '%'; }
    function deltaClass(d) { if (d == null || d === '') return ''; return Number(d) >= 0 ? 'delta-pos' : 'delta-neg'; }
    function filtrarPorSiteYFC(arr, siteFilter, fcFilter) {
      if (!siteFilter && !fcFilter) return arr;
      return arr.filter(function(r) {
        var okSite = !siteFilter || r[0] === siteFilter;
        var okFC = !fcFilter || r[1] === fcFilter;
        return okSite && okFC;
      });
    }
    function buscarValorFC(arr, site, fc, indiceP3) {
      var r = arr.find(function(x) { return x[0] === site && x[1] === fc; });
      return r ? r[indiceP3] : null;
    }
    function valorParaAnio(arr, anio, idxP1, idxP2, idxP3) {
      if (anio === '2025') { var p1 = arr[idxP1], p2 = arr[idxP2]; return (p1 != null && p2 != null) ? (p1 + p2) / 2 : (p2 != null ? p2 : p1); }
      return arr[idxP3];
    }
    function updateKpiCards(siteFilter, fcFilter, anio) {
      anio = anio || (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      var scope = '';
      var picking, packing, tote, share;
      if (fcFilter) {
        var todos = datosPickingFC.concat(datosPackingFC).concat(datosToteFC).concat(datosShareFC);
        var s = siteFilter || (function() { for (var i = 0; i < todos.length; i++) if (todos[i][1] === fcFilter) return todos[i][0]; return ''; })();
        scope = ' · ' + (s || '') + ' ' + fcFilter;
        var rPick = datosPickingFC.find(function(x) { return x[0] === s && x[1] === fcFilter; });
        var rPack = datosPackingFC.find(function(x) { return x[0] === s && x[1] === fcFilter; });
        var rTote = datosToteFC.find(function(x) { return x[0] === s && x[1] === fcFilter; });
        var rShare = datosShareFC.find(function(x) { return x[0] === s && x[1] === fcFilter; });
        picking = rPick ? valorParaAnio(rPick, anio, 2, 3, 4) : null;
        packing = rPack ? valorParaAnio(rPack, anio, 2, 3, 4) : null;
        tote = rTote ? valorParaAnio(rTote, anio, 2, 3, 4) : null;
        share = rShare ? valorParaAnio(rShare, anio, 2, 3, 4) : null;
      } else {
        var siteKey = siteFilter || 'Total';
        scope = siteFilter ? ' · ' + siteFilter : ' · Total';
        var R = resumenSiteFull[siteKey] || resumenSiteFull.Total;
        picking = R ? valorParaAnio(R.picking, anio, 0, 1, 2) : null;
        packing = R ? valorParaAnio(R.packing, anio, 0, 1, 2) : null;
        tote = R ? valorParaAnio(R.tote, anio, 0, 1, 2) : null;
        share = R ? valorParaAnio(R.share, anio, 0, 1, 2) : null;
      }
      document.getElementById('kpi-picking').textContent = picking != null ? fmt(picking) : '—';
      document.getElementById('kpi-packing').textContent = packing != null ? fmt(packing) : '—';
      document.getElementById('kpi-tote').textContent = tote != null ? fmt(tote) : '—';
      document.getElementById('kpi-share').textContent = share != null ? fmt(share) + '%' : '—';
      document.getElementById('kpi-picking-label').textContent = 'Productividad efectiva (Picking)' + scope + ' · ' + anio;
      document.getElementById('kpi-packing-label').textContent = 'Productividad efectiva (Packing)' + scope + ' · ' + anio;
      document.getElementById('kpi-tote-label').textContent = 'Piezas por Tote (#unidades/#totes)' + scope + ' · ' + anio;
      document.getElementById('kpi-share-label').textContent = 'Share Retiros' + scope + ' · ' + anio;
    }
    function renderResumenTable(anio, siteFilter) {
      anio = anio || (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      siteFilter = siteFilter || '';
      var thead = document.getElementById('tabla-kpis-thead');
      var tbody = document.getElementById('tabla-kpis-body');
      var sites = siteFilter ? SITES_ORDER.filter(function(s) { return s === siteFilter || s === 'Total'; }) : SITES_ORDER.slice();
      var headerHtml, fila = function(site, kpi, vals, esPct) {
        var v0 = esPct ? fmtPct(vals[0]) : fmt(vals[0]), v1 = esPct ? fmtPct(vals[1]) : fmt(vals[1]), v2 = esPct ? fmtPct(vals[2]) : fmt(vals[2]);
        var d21 = vals[0] != null && vals[1] != null ? (vals[1] - vals[0]) / vals[0] * 100 : null;
        var d32 = vals[1] != null && vals[2] != null ? (vals[2] - vals[1]) / vals[1] * 100 : null;
        var d31 = vals[0] != null && vals[2] != null ? (vals[2] - vals[0]) / vals[0] * 100 : null;
        if (anio === '2025') return '<tr><td>' + site + '</td><td class="num">' + v0 + '</td><td class="num">' + v1 + '</td><td class="num delta-col ' + deltaClass(d21) + '">' + (d21 != null ? fmt(d21) + '%' : '—') + '</td></tr>';
        if (anio === '2026') return '<tr><td>' + site + '</td><td class="num">' + v2 + '</td></tr>';
        return '<tr><td>' + site + '</td><td class="num">' + v0 + '</td><td class="num">' + v1 + '</td><td class="num">' + v2 + '</td><td class="num delta-col ' + deltaClass(d31) + '">' + (d31 != null ? fmt(d31) + '%' : '—') + '</td><td class="num delta-col ' + deltaClass(d32) + '">' + (d32 != null ? fmt(d32) + '%' : '—') + '</td></tr>';
      };
      if (anio === '2025') headerHtml = '<tr><th>Site</th><th class="num th-period">Pre-implemen<br>(01 Oct - 30 Nov 2025)</th><th class="num th-period">Pre-implemen<br>(01-31 Dic 2025)</th><th class="num delta-col">Delta Dic vs Oct+Nov</th></tr>';
      else if (anio === '2026') headerHtml = '<tr><th>Site</th><th class="num th-period">Post-implemen<br>(19 Ene - ' + fechaFinPostLabel() + ')</th></tr>';
      else headerHtml = '<tr><th>Site</th><th class="num th-period">Pre-implemen<br>(01 Oct - 30 Nov 2025)</th><th class="num th-period">Pre-implemen<br>(01-31 Dic 2025)</th><th class="num th-period">Post-implemen<br>(19 Ene - ' + fechaFinPostLabel() + ')</th><th class="num delta-col">Delta vs Oct+Nov</th><th class="num delta-col">Delta vs Dic</th></tr>';
      thead.innerHTML = headerHtml;
      var html = '';
      ['picking','packing','tote','share'].forEach(function(kpiName, idx) {
        var nombres = { picking: 'Productividad efectiva (Picking)', packing: 'Productividad efectiva (Packing)', tote: 'Piezas por Tote', share: 'Share Retiros' };
        var esPct = kpiName === 'share';
        var colSpan = anio === '2025' ? 4 : anio === '2026' ? 2 : 6;
        html += '<tr class="kpi-group"><td colspan="' + colSpan + '">' + nombres[kpiName] + '</td></tr>';
        for (var i = 0; i < sites.length; i++) {
          var s = sites[i], R = resumenSiteFull[s];
          if (!R) continue;
          html += fila(s, kpiName, R[kpiName], esPct);
        }
      });
      tbody.innerHTML = html;
    }
    function renderTablaFC(siteFilter, fcFilter, anio) {
      anio = anio || (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      siteFilter = siteFilter || '';
      fcFilter = fcFilter || '';
      var pick = filtrarPorSiteYFC(datosPickingFC, siteFilter, fcFilter);
      var pack = filtrarPorSiteYFC(datosPackingFC, siteFilter, fcFilter);
      var tote = filtrarPorSiteYFC(datosToteFC, siteFilter, fcFilter);
      var share = filtrarPorSiteYFC(datosShareFC, siteFilter, fcFilter);
      var thead = document.getElementById('tabla-fc-thead');
      var tbody = document.getElementById('tabla-fc-body');
      var nCol = anio === '2025' ? 5 : anio === '2026' ? 3 : 7;
      var labelPost = '19 Ene - ' + fechaFinPostLabel();
      var headerRowFC = anio === '2025' ? '<tr class="row-header"><th>Site</th><th>FC</th><th class="num th-period">Pre-implemen<br>(01 Oct - 30 Nov 2025)</th><th class="num th-period">Pre-implemen<br>(01-31 Dic 2025)</th><th class="num delta-col">Delta Dic vs Oct+Nov</th></tr>' : anio === '2026' ? '<tr class="row-header"><th>Site</th><th>FC</th><th class="num th-period">Post-implemen<br>(' + labelPost + ')</th></tr>' : '<tr class="row-header"><th>Site</th><th>FC</th><th class="num th-period">Pre-implemen<br>(01 Oct - 30 Nov 2025)</th><th class="num th-period">Pre-implemen<br>(01-31 Dic 2025)</th><th class="num th-period">Post-implemen<br>(' + labelPost + ')</th><th class="num delta-col">Delta vs Oct+Nov</th><th class="num delta-col">Delta vs Dic</th></tr>';
      function filas(data, esPct) {
        var out = '';
        for (var i = 0; i < data.length; i++) {
          var r = data[i], site = r[0], fc = r[1], p1 = r[2], p2 = r[3], p3 = r[4], d1 = r[5], d2 = r[6];
          var v1 = esPct ? fmtPct(p1) : fmt(p1), v2 = esPct ? fmtPct(p2) : fmt(p2), v3 = esPct ? fmtPct(p3) : fmt(p3);
          var d21 = (p1 != null && p2 != null) ? (p2 - p1) / p1 * 100 : null;
          if (anio === '2025') { out += '<tr><td>' + site + '</td><td>' + fc + '</td><td class="num">' + v1 + '</td><td class="num">' + v2 + '</td><td class="num delta-col ' + deltaClass(d21) + '">' + (d21 != null ? fmt(d21) + '%' : '—') + '</td></tr>'; continue; }
          if (anio === '2026') { out += '<tr><td>' + site + '</td><td>' + fc + '</td><td class="num">' + v3 + '</td></tr>'; continue; }
          var dd1 = d1 != null ? fmt(d1) + '%' : '—', dd2 = d2 != null ? fmt(d2) + '%' : '—';
          out += '<tr><td>' + site + '</td><td>' + fc + '</td><td class="num">' + v1 + '</td><td class="num">' + v2 + '</td><td class="num">' + v3 + '</td><td class="num ' + deltaClass(d1) + '">' + dd1 + '</td><td class="num ' + deltaClass(d2) + '">' + dd2 + '</td></tr>';
        }
        return out;
      }
      var html = '';
      html += '<tr class="kpi-group"><td colspan="' + nCol + '">Productividad efectiva (Picking) · por FC</td></tr>' + filas(pick, false);
      html += (anio === '2025' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">53,8</td><td class="num">56</td><td class="num">—</td></tr>' : anio === '2026' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">60,8</td></tr>' : '<tr class="total-row"><td>Total</td><td>—</td><td class="num">53,8</td><td class="num">56</td><td class="num">60,8</td><td class="num delta-pos">13,0%</td><td class="num delta-pos">8,6%</td></tr>');
      html += headerRowFC + '<tr class="kpi-group"><td colspan="' + nCol + '">Productividad efectiva (Packing) · por FC</td></tr>' + filas(pack, false);
      html += (anio === '2025' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">130,1</td><td class="num">120,9</td><td class="num">—</td></tr>' : anio === '2026' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">139,7</td></tr>' : '<tr class="total-row"><td>Total</td><td>—</td><td class="num">130,1</td><td class="num">120,9</td><td class="num">139,7</td><td class="num delta-pos">7,4%</td><td class="num delta-pos">15,6%</td></tr>');
      html += headerRowFC + '<tr class="kpi-group"><td colspan="' + nCol + '">Piezas por Tote (#unidades/#totes)</td></tr>' + filas(tote, false);
      html += (anio === '2025' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">11,9</td><td class="num">11,9</td><td class="num">—</td></tr>' : anio === '2026' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">12,2</td></tr>' : '<tr class="total-row"><td>Total</td><td>—</td><td class="num">11,9</td><td class="num">11,9</td><td class="num">12,2</td><td class="num delta-pos">2,5%</td><td class="num delta-pos">2,5%</td></tr>');
      html += headerRowFC + '<tr class="kpi-group"><td colspan="' + nCol + '">Share Retiros · por FC</td></tr>' + filas(share, true);
      html += (anio === '2025' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">68,9%</td><td class="num">63,7%</td><td class="num">—</td></tr>' : anio === '2026' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">35,4%</td></tr>' : '<tr class="total-row"><td>Total</td><td>—</td><td class="num">68,9%</td><td class="num">63,7%</td><td class="num">35,4%</td><td class="num delta-neg">-48,7%</td><td class="num delta-neg">-44,5%</td></tr>');
      thead.innerHTML = headerRowFC;
      tbody.innerHTML = html;
    }
    function aplicarFiltros() {
      var anio = (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      var site = document.getElementById('site').value;
      var fc = document.getElementById('fc').value;
      var todosLosFC = datosPickingFC.concat(datosPackingFC).concat(datosToteFC).concat(datosShareFC);
      var sitioDelFC = null;
      if (fc) { for (var k = 0; k < todosLosFC.length; k++) { if (todosLosFC[k][1] === fc) { sitioDelFC = todosLosFC[k][0]; break; } } }
      var siteParaResumen = site || sitioDelFC;
      updateKpiCards(site, fc, anio);
      renderResumenTable(anio, siteParaResumen);
      renderTablaFC(site, fc, anio);
    }
    function llenarFiltroFC(siteFilter) {
      var todos = datosPickingFC.concat(datosPackingFC).concat(datosToteFC).concat(datosShareFC);
      var unicos = {};
      for (var i = 0; i < todos.length; i++) {
        var s = todos[i][0], f = todos[i][1];
        if (siteFilter && s !== siteFilter) continue;
        if (!unicos[f]) unicos[f] = s;
      }
      var fcs = Object.keys(unicos).sort();
      var sel = document.getElementById('fc');
      var valorActual = sel.value;
      sel.innerHTML = '<option value="">Todos</option>';
      for (var j = 0; j < fcs.length; j++) {
        var opt = document.createElement('option');
        opt.value = fcs[j];
        opt.textContent = fcs[j];
        sel.appendChild(opt);
      }
      if (valorActual && fcs.indexOf(valorActual) !== -1) sel.value = valorActual;
    }
    function fechaHoy() {
      var d = new Date();
      return ('0' + d.getDate()).slice(-2) + '/' + ('0' + (d.getMonth() + 1)).slice(-2) + '/' + d.getFullYear();
    }
    document.addEventListener('DOMContentLoaded', function() {
      var hoy = fechaHoy();
      var finPost = fechaFinPostLabel();
      var elNota = document.getElementById('fecha-hoy-nota');
      var elFooter = document.getElementById('fecha-hoy-footer');
      var elFinPostNota = document.getElementById('fecha-fin-post-nota');
      var elFinPostTexto = document.getElementById('fecha-fin-post-texto');
      if (elNota) elNota.textContent = hoy;
      if (elFooter) elFooter.textContent = hoy;
      if (elFinPostNota) elFinPostNota.textContent = finPost;
      if (elFinPostTexto) elFinPostTexto.textContent = finPost;
      var anio = (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      llenarFiltroFC('');
      renderResumenTable(anio, '');
      renderTablaFC('', '', anio);
      updateKpiCards('', '', anio);
      document.getElementById('anio').addEventListener('change', aplicarFiltros);
      document.getElementById('site').addEventListener('change', function() { llenarFiltroFC(this.value); aplicarFiltros(); });
      document.getElementById('fc').addEventListener('change', aplicarFiltros);
    });
    function descargarCSV() {
      var table = document.getElementById('tabla-kpis');
      var rows = table.querySelectorAll('tr');
      var csv = [];
      for (var i = 0; i < rows.length; i++) {
        var cells = rows[i].querySelectorAll('th, td');
        var row = [];
        for (var j = 0; j < cells.length; j++) row.push('"' + (cells[j].textContent || '').trim().replace(/"/g, '""') + '"');
        csv.push(row.join(','));
      }
      var table2 = document.getElementById('tabla-fc');
      if (table2) {
        var rows2 = table2.querySelectorAll('tr');
        for (var i = 0; i < rows2.length; i++) {
          var cells = rows2[i].querySelectorAll('th, td');
          var row = [];
          for (var j = 0; j < cells.length; j++) row.push('"' + (cells[j].textContent || '').trim().replace(/"/g, '""') + '"');
          csv.push(row.join(','));
        }
      }
      var blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'kpis_pre_post_centralizacion_' + new Date().toISOString().slice(0,10) + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }
  </script>
</body>
</html>
