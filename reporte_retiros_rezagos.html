<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Report Scorecard Retiros y Rezagos</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #fff;
      color: #333;
      margin: 0;
      padding: 24px;
      line-height: 1.5;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 {
      color: #ffe600;
      background: #3483fa;
      margin: -24px -24px 24px -24px;
      padding: 20px 24px;
      font-size: 1.5rem;
      font-weight: 700;
    }
    h2 {
      color: #3483fa;
      font-size: 1.2rem;
      margin-top: 32px;
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 2px solid #ffe600;
    }
    /* Filtros */
    .filtros {
      background: #f5f5f5;
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      align-items: end;
    }
    .filtros label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: #666;
      margin-bottom: 6px;
    }
    .filtros select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
      background: #fff;
    }
    .filtros select:focus {
      outline: none;
      border-color: #3483fa;
      box-shadow: 0 0 0 2px rgba(52, 131, 250, 0.2);
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary {
      background: #3483fa;
      color: #fff;
    }
    .btn-primary:hover { background: #2968c8; }
    .btn-secondary {
      background: #fff;
      color: #3483fa;
      border: 1px solid #3483fa;
    }
    .btn-secondary:hover { background: #f0f7ff; }
    /* KPIs destacados */
    .kpi {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }
    .kpi-card {
      background: #f5f5f5;
      border-left: 4px solid #3483fa;
      padding: 16px 20px;
      min-width: 140px;
      border-radius: 4px;
    }
    .kpi-card .value { font-size: 1.75rem; font-weight: 700; color: #333; }
    .kpi-card .label { font-size: 0.85rem; color: #666; margin-top: 4px; }
    /* Tabla principal */
    .tabla-wrap { overflow-x: auto; margin-bottom: 24px; max-width: 100%; }
    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      font-size: 0.85rem;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
      border-radius: 4px;
      overflow: hidden;
    }
    th, td { padding: 8px 6px; text-align: center; }
    th {
      background: #3483fa;
      color: #fff;
      font-weight: 600;
    }
    th.th-period { white-space: normal; line-height: 1.2; text-align: center; word-break: break-word; }
    th.num, td.num { text-align: center; font-variant-numeric: tabular-nums; }
    /* Resumen por Site: 6 columnas */
    #tabla-kpis th:nth-child(1), #tabla-kpis td:nth-child(1) { width: 10%; }
    #tabla-kpis th:nth-child(2), #tabla-kpis th:nth-child(3), #tabla-kpis th:nth-child(4),
    #tabla-kpis td:nth-child(2), #tabla-kpis td:nth-child(3), #tabla-kpis td:nth-child(4) { width: 18%; }
    #tabla-kpis th:nth-child(5), #tabla-kpis th:nth-child(6), #tabla-kpis td:nth-child(5), #tabla-kpis td:nth-child(6) { width: 14%; }
    /* Detalle por FC: 7 columnas */
    #tabla-fc th:nth-child(1), #tabla-fc td:nth-child(1) { width: 8%; }
    #tabla-fc th:nth-child(2), #tabla-fc td:nth-child(2) { width: 7%; }
    #tabla-fc th:nth-child(3), #tabla-fc th:nth-child(4), #tabla-fc th:nth-child(5),
    #tabla-fc td:nth-child(3), #tabla-fc td:nth-child(4), #tabla-fc td:nth-child(5) { width: 17%; }
    #tabla-fc th:nth-child(6), #tabla-fc th:nth-child(7), #tabla-fc td:nth-child(6), #tabla-fc td:nth-child(7) { width: 13%; }
    tr:nth-child(even) { background: #f9f9f9; }
    tr.row-header th { background: #3483fa; color: #fff; font-weight: 700; }
    tr:hover { background: #f0f7ff; }
    tr.kpi-group { font-weight: 600; background: #e8f0fe; }
    tr.total-row { font-weight: 700; background: #e8f0fe; }
    tr.total-row td { font-weight: 700; }
    tr.historial-seccion td { background: #5a6c7d; color: #fff; font-weight: 700; padding: 10px 8px; font-size: 0.95rem; }
    .delta-pos { color: #00a650; }
    .delta-neg { color: #f23d4f; }
    .note { font-size: 0.9rem; color: #666; margin-bottom: 16px; }
    .footer {
      margin-top: 40px;
      padding-top: 16px;
      border-top: 1px solid #eee;
      font-size: 0.8rem;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Daily Report Scorecard Retiros y Rezagos</h1>
    <p class="note">Datos desde <strong>01/10/2025</strong> hasta el <strong id="fecha-hoy-nota"></strong> (fecha de actualización). Períodos: Pre (01 Oct-30 Nov), Pre (01-31 Dic), Post (19 Ene - <span id="fecha-fin-post-nota"></span>).</p>

    <!-- Filtros: Año, Site, FC -->
    <h2>Filtros</h2>
    <div class="filtros">
      <div>
        <label for="anio">Año</label>
        <select id="anio">
          <option value="Todos">Todos</option>
          <option value="2025">2025</option>
          <option value="2026">2026</option>
        </select>
      </div>
      <div>
        <label for="site">Site / País</label>
        <select id="site">
          <option value="">Todos</option>
          <option value="MLB">MLB</option>
          <option value="MLM">MLM</option>
          <option value="MLA">MLA</option>
          <option value="MLC">MLC</option>
          <option value="MCO">MCO</option>
        </select>
      </div>
      <div>
        <label for="fc">FC</label>
        <select id="fc"><option value="">Todos</option></select>
      </div>
      <div style="display: flex; gap: 8px;">
        <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">Aplicar</button>
        <button type="button" class="btn btn-secondary" onclick="descargarCSV()">Descargar CSV</button>
      </div>
    </div>

    <h2>Resumen KPIs</h2>
    <p class="note">Todo el dashboard (tarjetas, Resumen por Site y Detalle por FC) cambia según los filtros Año, Site y FC.</p>
    <div class="kpi" id="kpi-cards">
      <div class="kpi-card">
        <div class="value" id="kpi-picking">61,4</div>
        <div class="label" id="kpi-picking-label">Productividad efectiva (Picking)</div>
      </div>
      <div class="kpi-card">
        <div class="value" id="kpi-packing">139,8</div>
        <div class="label" id="kpi-packing-label">Productividad efectiva (Packing)</div>
      </div>
      <div class="kpi-card">
        <div class="value" id="kpi-tote">6</div>
        <div class="label" id="kpi-tote-label">Piezas por Tote (#unidades/#totes)</div>
      </div>
      <div class="kpi-card">
        <div class="value" id="kpi-share">69,2%</div>
        <div class="label" id="kpi-share-label">Share Retiros</div>
      </div>
    </div>

    <h2>Vista general (Resumen por Site y Detalle por FC)</h2>
    <p class="note">KPIs, deltas y tablas por Site/FC según filtros Año, Site y FC.</p>
    <div class="tabla-wrap">
      <table id="tabla-kpis">
        <thead id="tabla-kpis-thead"><tr><th>Site</th></tr></thead>
        <tbody id="tabla-kpis-body"></tbody>
      </table>
    </div>

    <h2>Detalle por FC (centro logístico)</h2>
    <div class="tabla-wrap">
      <table id="tabla-fc">
        <thead id="tabla-fc-thead"><tr><th>Site</th><th>FC</th></tr></thead>
        <tbody id="tabla-fc-body"></tbody>
      </table>
    </div>

    <h2>Historial (sin deltas)</h2>
    <p class="note">Serie en el tiempo desde 01/10/2025. Mismos filtros Año y Site.</p>
    <div class="filtros" style="margin-bottom: 12px;">
      <div>
        <label for="historial-dimension">Ver por dimensión</label>
        <select id="historial-dimension">
          <option value="semana">Semana</option>
          <option value="mes">Mes</option>
        </select>
      </div>
    </div>
    <div class="tabla-wrap">
      <table id="tabla-historial">
        <thead id="tabla-historial-thead"><tr><th>Periodo</th><th>Site</th><th class="num">Picking</th><th class="num">Packing</th><th class="num">Unit/Tote</th><th class="num">Share %</th></tr></thead>
        <tbody id="tabla-historial-body"></tbody>
      </table>
    </div>

    <h2>Lógica de métricas</h2>
    <div class="note" style="margin-bottom: 24px;">
      <strong>Pre-implementación (P1: 01 Oct–30 Nov 2025; P2: 01–31 Dic 2025):</strong> solo procesos <em>withdrawals</em> (retiros).<br>
      <strong>Post-implementación (P3: 19 Ene – <span id="fecha-fin-post-texto"></span>):</strong> desde el <strong>19/01/2026</strong> se suman los procesos <em>disposal</em>. La fecha de fin del post es la del día de la última actualización.<br><br>
      <strong>Resumen por métrica (filtros y fórmula):</strong><br>
      • <strong>Productividad efectiva (Picking):</strong> solo procesos <em>picking</em>. Pre: picking_withdrawals. Post: picking_withdrawals + picking_disposal. Fórmula: SUM(UNITS)/SUM(P_TIME).<br>
      • <strong>Productividad efectiva (Packing):</strong> solo procesos <em>packing</em>. Pre: packing_withdrawals. Post: packing_withdrawals + packing_disposal. Fórmula: SUM(UNITS)/SUM(P_TIME).<br>
      • <strong>Piezas por Tote:</strong> #unidades/#totes. Filtro Process Path: solo rutas con PP_WITHDRAWAL_SINGLE_SKU, PP_WITHDRAWAL_DIRECT_PACKING, PP_WITHDRAWAL_SORT. Fórmula: SUM(UNIT_QTY_PICKED)/SUM(TOTES_PER_CART_USED).<br>
      • <strong>Share Retiros:</strong> solo procesos <em>packing</em> (packing_withdrawals, packing_disposal). Share % = 100×Withdrawals/(Withdrawals+Disposal). Antes de ~9 Dic no había disposal → 100%.
    </div>

    <h2>Fuentes de datos</h2>
    <div class="footer">
      <strong>Tablas principales (BigQuery, proyecto meli-bi-data):</strong><br>
      • <strong>SBOX_REVERSA.REMOVALS_PRODUCTIVITY_AREA</strong> — Productividad efectiva (Picking y Packing), WAREHOUSE = FC.<br>
      • <strong>SBOX_REVERSA.RETURNS_NP_OUT</strong> — Share Retiros, LOGISTIC_CENTER_ID = FC.<br>
      • <strong>WHOWNER.LK_SOT_PICKING_MAIN_TABLE</strong> — Piezas por Tote: SUM(UNIT_QTY_PICKED)/SUM(TOTES_PER_CART_USED).<br>
      Datos desde 01/10/2025 hasta el <span id="fecha-hoy-footer"></span> (actualización diaria).
    </div>
  </div>

  <script>
    // Picking: datos reales BigQuery RETURNS_NP_OUT. Pre: picking_withdrawals; Post: picking_withdrawals + picking_disposal (impl. 19/01/2026).
    var datosPickingFC = [["MCO","COCU02",110.2,113.4,102.8,-6.7,-9.4],["MLA","ARBA01",56.4,58.3,50.3,-10.8,-13.8],["MLA","ARBA02",11.8,48.3,27.8,135.8,-42.5],["MLA","ARBA04",39.9,61.3,29.2,-26.9,-52.3],["MLB","BRBA01",53.4,50.5,55.1,3.3,9.3],["MLB","BRBA02",19.8,34,28.4,43.5,-16.6],["MLB","BRDF01",58.7,50.4,75.3,28.2,49.5],["MLB","BRMG01",37.7,42.7,56.6,50.2,32.6],["MLB","BRMG02",64.2,129.6,77.8,21.3,-39.9],["MLB","BRMG03",34.1,21.8,48.9,43.1,124.5],["MLB","BRMG04",0,0,61.9,null,null],["MLB","BRPE01",61.3,60.4,56.3,-8.2,-6.9],["MLB","BRPR01",30.9,32.2,41.4,33.7,28.6],["MLB","BRRC01",101.4,93.9,119.1,17.4,26.8],["MLB","BRRC02",43,44.8,75.3,75.2,67.8],["MLB","BRRC03",67.6,75.3,110.9,64.1,47.3],["MLB","BRRJ02",48.2,49.4,48.5,0.6,-1.8],["MLB","BRRS01",74,67.8,55.2,-25.4,-18.6],["MLB","BRSC02",59.9,63,58.8,-1.8,-6.6],["MLB","BRSP02",34.3,36.6,41,19.4,12.2],["MLB","BRSP04",52.7,69.7,65.2,23.8,-6.4],["MLB","BRSP06",97.9,94.7,88.3,-9.8,-6.8],["MLB","BRSP09",27.4,12.9,25.8,-6.1,100.3],["MLB","BRSP10",44.3,52.3,40.7,-8,-22.1],["MLB","BRSP11",62.3,49.1,43.3,-30.5,-11.9],["MLB","BRSP14",60.1,63.4,71.1,18.3,12.1],["MLB","BRSP15",60.9,59.1,58.4,-4.2,-1.3],["MLB","BRSP18",68.2,68.6,70.7,3.6,3.1],["MLB","BRSP19",72.7,72.1,79.3,9,9.9],["MLB","BRSP24",41.2,36.9,51.4,24.8,39.2],["MLB","BRSP25",28.6,53.1,91,218.7,71.2],["MLB","SSP21",0,null,null,null,null],["MLC","CLBB01",45,52.2,58.8,30.8,12.5],["MLC","CLRM03",91.2,85.9,96.8,6.1,12.6],["MLM","MXCD02",60.9,64.6,79.4,30.4,22.9],["MLM","MXCD05",39.2,40.1,39.2,0.2,-2],["MLM","MXCD06",165.1,143.2,150.6,-8.8,5.1],["MLM","MXCD07",78,62.4,80.4,3.1,28.9],["MLM","MXCD08",2.9,11.4,20.2,586.1,77.3],["MLM","MXCD09",43.6,35.7,40.5,-7.2,13.5],["MLM","MXCD10",79.6,78.4,111,39.4,41.6],["MLM","MXCD11",64.5,65.4,68.3,5.8,4.5],["MLM","MXCD12",30.7,23.9,23.6,-23.3,-1.4],["MLM","MXCD14",null,null,1.9,null,null],["MLM","MXGT01",58.8,48.5,61.3,4.2,26.2],["MLM","MXJC01",78.6,68.6,75.9,-3.4,10.7],["MLM","MXNL01",60.6,56.8,76.7,26.5,34.9],["MLM","MXRC03",115.9,77.1,102.7,-11.4,33.2],["MLM","MXSO01",41.9,67,71.2,69.8,6.2],["MLM","MXYU01",63.2,65.6,67.4,6.6,2.7],["MLM","USTX01",218.3,140.3,203.3,-6.8,44.9]];
    // Packing: datos reales BigQuery RETURNS_NP_OUT. Pre: packing_withdrawals; Post: + packing_disposal (impl. 19/01/2026).
    var datosPackingFC = [["MCO","COCU02",189.1,171.7,147.8,-21.9,-13.9],["MLA","ARBA01",102,102.2,88.2,-13.6,-13.7],["MLA","ARBA02",25,27.8,28.7,14.8,3.5],["MLA","ARBA04",32.1,42.8,64.2,100,50.1],["MLB","BRBA01",174,151.2,179.5,3.2,18.7],["MLB","BRBA02",55.9,60.2,49.9,-10.7,-17.1],["MLB","BRDF01",93.6,92,82.5,-11.9,-10.4],["MLB","BRMG01",63.9,68.5,85.4,33.6,24.5],["MLB","BRMG02",163.8,226.2,151.7,-7.4,-33],["MLB","BRMG03",57.4,46.4,52.1,-9.1,12.5],["MLB","BRMG04",0,null,24.8,null,null],["MLB","BRPE01",134.5,115.6,132,-1.8,14.2],["MLB","BRPR01",51.4,61.1,99.4,93.5,62.7],["MLB","BRRC01",141.2,166.1,132.8,-6,-20],["MLB","BRRC02",29.3,41.6,70.1,139.2,68.3],["MLB","BRRC03",51.4,58.6,62,20.6,5.9],["MLB","BRRJ02",151.1,124.8,148,-2.1,18.6],["MLB","BRRS01",139.9,126.3,135.8,-2.9,7.5],["MLB","BRSC02",127.6,117.1,124.4,-2.5,6.2],["MLB","BRSP02",86.1,92.2,98.6,14.6,7],["MLB","BRSP04",236.9,211.4,257.6,8.7,21.8],["MLB","BRSP06",174.3,161,181.6,4.2,12.8],["MLB","BRSP09",143.2,430.2,295.2,106.2,-31.4],["MLB","BRSP10",110.9,78.4,78.3,-29.4,-0.1],["MLB","BRSP11",122.5,59.3,120.5,-1.7,103.2],["MLB","BRSP14",217.9,201.9,208,-4.6,3],["MLB","BRSP15",198.7,158,197.4,-0.6,25],["MLB","BRSP18",176.8,171.4,192.9,9.1,12.5],["MLB","BRSP19",168.2,160.9,204.1,21.3,26.8],["MLB","BRSP24",43.8,64.5,113.4,159,75.8],["MLB","BRSP25",45,102.9,146.3,224.9,42.1],["MLB","CAMPINAS",null,0,null,null,null],["MLC","CLBB01",37.6,44.3,67.7,80,52.8],["MLC","CLRM03",165.8,172,196.3,18.4,14.1],["MLM","MXCD02",162.5,134.2,189.1,16.4,40.9],["MLM","MXCD05",53.4,47.6,55.2,3.4,16],["MLM","MXCD06",189.1,186.4,242.5,28.2,30.1],["MLM","MXCD07",229,173,214.7,-6.2,24.1],["MLM","MXCD08",45.2,84.6,99,119,16.9],["MLM","MXCD09",92.7,68.9,93.7,1.1,35.9],["MLM","MXCD10",281.3,248.6,338.7,20.4,36.2],["MLM","MXCD11",110.6,88.7,117.7,6.5,32.7],["MLM","MXCD12",59.7,54.6,70,17.2,28],["MLM","MXCD14",null,null,0.7,null,null],["MLM","MXGT01",161.9,146.4,157.9,-2.5,7.9],["MLM","MXJC01",254.6,232.3,281.9,10.7,21.4],["MLM","MXNL01",187.9,174,206,9.6,18.4],["MLM","MXRC03",161.1,112.1,140.2,-12.9,25.1],["MLM","MXRC04",108.8,null,null,null,null],["MLM","MXSO01",36.3,79.5,87.7,141.4,10.4],["MLM","MXYU01",168.8,141.3,156.8,-7.1,10.9],["MLM","USTX01",130.7,145.6,118.8,-9.2,-18.4]];
    // Share Retiros % = 100*Withdrawals/(Withdrawals+Disposal) packing. Fuente: RETURNS_NP_OUT (query_share_retiros.sql). Antes 9-dic: solo withdrawals → 100%.
    var datosShareFC = [["MCO","COCU02",100,95.3,94.8,-5.2,-0.6],["MLA","ARBA01",100,93.5,89.4,-10.6,-4.4],["MLA","ARBA02",100,100,100,0,0],["MLA","ARBA04",100,100,88.4,-11.6,-11.6],["MLB","BRBA01",100,79.5,64.6,-35.4,-18.8],["MLB","BRBA02",100,100,64.1,-35.9,-35.9],["MLB","BRDF01",100,69.5,100,0,43.9],["MLB","BRMG01",100,56.4,59.5,-40.5,5.5],["MLB","BRMG02",100,86.7,76.7,-23.3,-11.5],["MLB","BRMG03",100,52.2,57.4,-42.6,10],["MLB","BRMG04",null,0,0,null,null],["MLB","BRPE01",100,80.2,69.3,-30.7,-13.6],["MLB","BRPR01",100,87.7,67.6,-32.4,-22.9],["MLB","BRRC01",100,83.8,80.2,-19.8,-4.4],["MLB","BRRC02",100,79.6,72.8,-27.2,-8.5],["MLB","BRRC03",100,92.8,91.8,-8.2,-1.1],["MLB","BRRJ02",100,73.1,75.2,-24.8,2.9],["MLB","BRRS01",100,100,71,-29,-29],["MLB","BRSC02",100,78,73.4,-26.6,-5.9],["MLB","BRSP02",100,65.3,79.7,-20.3,22],["MLB","BRSP04",100,83,65.1,-34.9,-21.6],["MLB","BRSP06",100,68.6,61.6,-38.4,-10.2],["MLB","BRSP09",100,23.1,0,-100,-100],["MLB","BRSP10",100,83.3,61,-39,-26.8],["MLB","BRSP11",100,88.4,61.1,-38.9,-30.8],["MLB","BRSP14",100,87.2,76.3,-23.7,-12.6],["MLB","BRSP15",100,81.3,90.8,-9.2,11.7],["MLB","BRSP18",100,85.9,73.6,-26.4,-14.3],["MLB","BRSP19",100,88.5,76,-24,-14.2],["MLB","BRSP24",100,100,59.2,-40.8,-40.8],["MLB","BRSP25",100,85.4,72,-28,-15.7],["MLC","CLBB01",100,100,98.5,-1.5,-1.5],["MLC","CLRM03",100,75.2,82.8,-17.2,10.2],["MLM","MXCD02",100,58.1,60.7,-39.3,4.6],["MLM","MXCD05",100,87,69.6,-30.4,-20.1],["MLM","MXCD06",100,80.5,71.6,-28.4,-11.1],["MLM","MXCD07",100,73.2,69.6,-30.4,-4.9],["MLM","MXCD08",100,58.5,88.4,-11.6,51.1],["MLM","MXCD09",100,70.6,56.4,-43.6,-20.1],["MLM","MXCD10",100,64.6,56,-44,-13.4],["MLM","MXCD11",100,67.7,68.3,-31.7,0.8],["MLM","MXCD12",100,91,61.2,-38.8,-32.8],["MLM","MXCD14",null,null,100,null,null],["MLM","MXGT01",100,63.6,64.7,-35.3,1.6],["MLM","MXJC01",100,82.1,68.7,-31.3,-16.3],["MLM","MXNL01",100,69.1,69.1,-30.9,0.1],["MLM","MXRC03",100,54.1,37.9,-62.1,-29.9],["MLM","MXRC04",100,null,null,null,null],["MLM","MXSO01",100,100,75.8,-24.2,-24.2],["MLM","MXYU01",100,76.6,68,-32,-11.2],["MLM","USTX01",100,48,73.2,-26.8,52.7]];
    // Piezas por Tote = SUM(UNIT_QTY_PICKED)/SUM(TOTES_PER_CART_USED). Filtro: PROCESS_PATH_CODE IN (PP_WITHDRAWAL_SINGLE_SKU, PP_WITHDRAWAL_DIRECT_PACKING, PP_WITHDRAWAL_SORT). Fuente: WHOWNER.LK_SOT_PICKING_MAIN_TABLE.
    var datosToteFC = [["MCO","COCU02",8.4,6.9,4.1,-51,-40.1],["MLA","ARBA01",5.5,7.8,6.4,15.8,-17.3],["MLA","ARBA02",2,5.3,2.6,32.4,-50],["MLA","ARBA04",2.4,4,4,69.9,0.1],["MLB","BRBA01",4.9,4.3,5,3.2,17.4],["MLB","BRBA02",2.4,2.8,4.2,74.3,50.4],["MLB","BRDF01",2.4,2.6,4.2,70.9,61],["MLB","BRMG01",6.7,4.5,10.1,49.8,122.8],["MLB","BRMG02",9.3,24.2,15.1,62.4,-37.5],["MLB","BRMG03",13.3,1.6,9,-32.3,472.7],["MLB","BRPE01",3.5,3.3,4.3,22.3,30.7],["MLB","BRPR01",1.9,2.5,2.8,45.4,12.2],["MLB","BRRC01",11.5,8.4,11.3,-1.5,34.7],["MLB","BRRC02",6.3,6.3,7.4,16.8,17.9],["MLB","BRRC03",11.2,12.3,17,51.1,38.4],["MLB","BRRJ02",4.4,3.9,4.8,7.8,21.4],["MLB","BRRS01",3.1,3.2,4.3,39.7,32.8],["MLB","BRSC02",7.4,5.6,5,-32,-10.6],["MLB","BRSP02",4.1,2.4,3.9,-6.6,58.5],["MLB","BRSP04",5.5,5.5,5.4,-1.4,-0.5],["MLB","BRSP06",15.6,16.2,20.8,33.1,28.4],["MLB","BRSP10",5.1,4.8,5,-3.3,4.7],["MLB","BRSP11",8.4,10.8,10.2,20.9,-5.6],["MLB","BRSP14",3.7,3.9,4.9,34.5,27.6],["MLB","BRSP15",3.7,3.5,4.3,18.6,22.9],["MLB","BRSP18",6.9,5.8,5.6,-18.7,-2.6],["MLB","BRSP19",6.7,6,6.2,-6.9,3.8],["MLB","BRSP24",2.4,2.4,3.5,46.6,43.7],["MLB","BRSP25",7,6.5,5.8,-16.3,-10],["MLC","CLBB01",1.3,1.4,1.5,18.2,6],["MLC","CLRM03",6.1,5,8.9,44.9,77.9],["MLM","MXCD02",6.2,6.4,7,12.4,9.7],["MLM","MXCD05",4.3,3.9,3.3,-23.8,-16.3],["MLM","MXCD06",22.4,18.7,15.2,-32.2,-18.7],["MLM","MXCD07",4.6,3.9,6,29.6,52.5],["MLM","MXCD08",3.3,3.2,5.3,61.6,69.7],["MLM","MXCD09",3.3,2.9,3.7,10.4,28.6],["MLM","MXCD10",5.9,5.7,6.8,13.8,18.8],["MLM","MXCD11",5.1,5,4.8,-4.8,-3],["MLM","MXCD12",6.4,5.8,5.7,-9.8,-2],["MLM","MXCD14",null,null,5.4,null,null],["MLM","MXGT01",4.5,4.6,5.6,25.2,20.8],["MLM","MXJC01",5.3,5.7,5.8,10,1.2],["MLM","MXNL01",7.4,7,8.2,10.9,16.9],["MLM","MXRC03",9.8,11,8,-18.5,-27.3],["MLM","MXSO01",2.2,2.5,4.2,87.8,66.3],["MLM","MXYU01",3.9,4.9,4.9,26.2,-0.9]];
    var resumenSite = { MLB: { picking: 55.6, packing: 133.1, tote: 5.5, share: 71.9 }, MLM: { picking: 68.9, packing: 158.3, tote: 6.4, share: 60.8 }, MLA: { picking: 50, packing: 87.7, tote: 6.4, share: 89.4 }, MLC: { picking: 96.7, packing: 196, tote: 8.7, share: 82.8 }, MCO: { picking: 102.8, packing: 147.8, tote: 4.1, share: 94.8 }, Total: { picking: 61.4, packing: 139.8, tote: 6, share: 69.2 } };
    var resumenSiteFull = { MLB: { picking: [47.1,52.6,55.6], packing: [120.5,119.5,133.1], tote: [5.4,4.9,5.5], share: [100,74.9,71.9] }, MLM: { picking: [61.6,57,68.9], packing: [147.5,121.9,158.3], tote: [5.5,5.4,6.4], share: [100,66.7,60.8] }, MLA: { picking: [56.4,58.3,50], packing: [101.8,101.4,87.7], tote: [5.5,7.7,6.4], share: [100,93.5,89.4] }, MLC: { picking: [91.1,85.9,96.7], packing: [165.5,171.5,196], tote: [6,4.8,8.7], share: [100,75.2,82.8] }, MCO: { picking: [110.2,113.4,102.8], packing: [189.1,171.7,147.8], tote: [8.4,6.9,4.1], share: [100,95.3,94.8] }, Total: { picking: [53.8,56,61.4], packing: [130.1,120.9,139.8], tote: [5.5,5.2,6], share: [100,72.9,69.2] } };
    // Historial: datos reales BigQuery (query_historial_semanal_site.sql y query_historial_mensual_site.sql). Solo en copia local; subir a GitHub cuando indiques.
    var historialSemanal = [
      { semana: '2025-09-29', site: 'MCO', picking: 99.1, packing: 176.7, tote: 8.8, share: 100 }, { semana: '2025-09-29', site: 'MLA', picking: 57.7, packing: 111.4, tote: 8.7, share: 100 }, { semana: '2025-09-29', site: 'MLB', picking: 44.7, packing: 124.5, tote: 6.3, share: 100 }, { semana: '2025-09-29', site: 'MLC', picking: 81.8, packing: 167.0, tote: 5.0, share: 100 }, { semana: '2025-09-29', site: 'MLM', picking: 57.5, packing: 146.4, tote: 5.2, share: 100 }, { semana: '2025-09-29', site: 'Total', picking: 50.2, packing: 132.3, tote: 6.0, share: 100 },
      { semana: '2025-10-06', site: 'MCO', picking: 107.9, packing: 260.2, tote: 5.5, share: 100 }, { semana: '2025-10-06', site: 'MLA', picking: 46.4, packing: 83.0, tote: 5.1, share: 100 }, { semana: '2025-10-06', site: 'MLB', picking: 43.7, packing: 119.8, tote: 6.0, share: 100 }, { semana: '2025-10-06', site: 'MLC', picking: 86.7, packing: 162.8, tote: 8.4, share: 100 }, { semana: '2025-10-06', site: 'MLM', picking: 65.4, packing: 142.8, tote: 5.1, share: 100 }, { semana: '2025-10-06', site: 'Total', picking: 52.1, packing: 126.5, tote: 5.6, share: 100 },
      { semana: '2025-10-13', site: 'MCO', picking: 105.9, packing: 208.8, tote: 2.6, share: 100 }, { semana: '2025-10-13', site: 'MLA', picking: 59.6, packing: 109.1, tote: 6.0, share: 100 }, { semana: '2025-10-13', site: 'MLB', picking: 43.7, packing: 118.1, tote: 4.7, share: 100 }, { semana: '2025-10-13', site: 'MLC', picking: 89.7, packing: 152.7, tote: 5.6, share: 100 }, { semana: '2025-10-13', site: 'MLM', picking: 63.6, packing: 151.9, tote: 5.3, share: 100 }, { semana: '2025-10-13', site: 'Total', picking: 52.5, packing: 131.3, tote: 5.1, share: 100 },
      { semana: '2025-10-20', site: 'MCO', picking: 107.4, packing: 167.8, tote: 35.6, share: 100 }, { semana: '2025-10-20', site: 'MLA', picking: 59.6, packing: 113.8, tote: 3.5, share: 100 }, { semana: '2025-10-20', site: 'MLB', picking: 42.1, packing: 115.1, tote: 6.0, share: 100 }, { semana: '2025-10-20', site: 'MLC', picking: 79.9, packing: 164.5, tote: 6.0, share: 100 }, { semana: '2025-10-20', site: 'MLM', picking: 57.1, packing: 135.5, tote: 6.4, share: 100 }, { semana: '2025-10-20', site: 'Total', picking: 49.0, packing: 124.0, tote: 6.1, share: 100 },
      { semana: '2025-10-27', site: 'MCO', picking: 109.6, packing: 183.3, tote: 6.0, share: 100 }, { semana: '2025-10-27', site: 'MLA', picking: 58.0, packing: 102.5, tote: 5.8, share: 100 }, { semana: '2025-10-27', site: 'MLB', picking: 49.2, packing: 119.2, tote: 5.4, share: 100 }, { semana: '2025-10-27', site: 'MLC', picking: 87.1, packing: 161.2, tote: 5.8, share: 100 }, { semana: '2025-10-27', site: 'MLM', picking: 60.8, packing: 147.2, tote: 5.5, share: 100 }, { semana: '2025-10-27', site: 'Total', picking: 54.2, packing: 128.5, tote: 5.6, share: 100 },
      { semana: '2025-11-03', site: 'MCO', picking: 119.6, packing: 185.6, tote: 10.2, share: 100 }, { semana: '2025-11-03', site: 'MLA', picking: 48.0, packing: 87.2, tote: null, share: 100 }, { semana: '2025-11-03', site: 'MLB', picking: 48.7, packing: 115.9, tote: 4.7, share: 100 }, { semana: '2025-11-03', site: 'MLC', picking: 95.4, packing: 157.5, tote: 6.6, share: 100 }, { semana: '2025-11-03', site: 'MLM', picking: 59.4, packing: 155.1, tote: 4.7, share: 100 }, { semana: '2025-11-03', site: 'Total', picking: 53.7, packing: 129.6, tote: 4.7, share: 100 },
      { semana: '2025-11-10', site: 'MCO', picking: 111.4, packing: 172.7, tote: 2.5, share: 100 }, { semana: '2025-11-10', site: 'MLA', picking: 53.0, packing: 91.7, tote: 5.6, share: 100 }, { semana: '2025-11-10', site: 'MLB', picking: 53.4, packing: 126.0, tote: 4.7, share: 100 }, { semana: '2025-11-10', site: 'MLC', picking: 113.7, packing: 197.4, tote: 9.8, share: 100 }, { semana: '2025-11-10', site: 'MLM', picking: 60.9, packing: 156.1, tote: 4.6, share: 100 }, { semana: '2025-11-10', site: 'Total', picking: 58.3, packing: 133.8, tote: 5.1, share: 100 },
      { semana: '2025-11-17', site: 'MCO', picking: 118.4, packing: 179.4, tote: 6.2, share: 100 }, { semana: '2025-11-17', site: 'MLA', picking: 55.5, packing: 104.6, tote: 4.5, share: 100 }, { semana: '2025-11-17', site: 'MLB', picking: 53.8, packing: 125.9, tote: 5.7, share: 100 }, { semana: '2025-11-17', site: 'MLC', picking: 93.8, packing: 181.7, tote: 6.2, share: 100 }, { semana: '2025-11-17', site: 'MLM', picking: 66.6, packing: 189.0, tote: 6.0, share: 100 }, { semana: '2025-11-17', site: 'Total', picking: 58.8, packing: 139.5, tote: 5.7, share: 100 },
      { semana: '2025-11-24', site: 'MCO', picking: 84.8, packing: 156.3, tote: 4.0, share: 100 }, { semana: '2025-11-24', site: 'MLA', picking: 68.6, packing: 115.1, tote: 5.1, share: 100 }, { semana: '2025-11-24', site: 'MLB', picking: 54.8, packing: 137.2, tote: 5.7, share: 100 }, { semana: '2025-11-24', site: 'MLC', picking: 87.2, packing: 163.1, tote: 1.8, share: 100 }, { semana: '2025-11-24', site: 'MLM', picking: 65.4, packing: 139.9, tote: 5.9, share: 100 }, { semana: '2025-11-24', site: 'Total', picking: 61.1, packing: 137.6, tote: 5.8, share: 100 },
      { semana: '2025-12-01', site: 'MCO', picking: 122.6, packing: 191.5, tote: 5.0, share: 100 }, { semana: '2025-12-01', site: 'MLA', picking: 61.2, packing: 102.8, tote: 7.2, share: 100 }, { semana: '2025-12-01', site: 'MLB', picking: 52.1, packing: 124.2, tote: 5.0, share: 100 }, { semana: '2025-12-01', site: 'MLC', picking: 86.2, packing: 168.2, tote: 5.2, share: 100 }, { semana: '2025-12-01', site: 'MLM', picking: 56.8, packing: 118.5, tote: 5.2, share: 100 }, { semana: '2025-12-01', site: 'Total', picking: 56.5, packing: 126.2, tote: 5.3, share: 100 },
      { semana: '2025-12-08', site: 'MCO', picking: 115.2, packing: 178.2, tote: 5.5, share: 100 }, { semana: '2025-12-08', site: 'MLA', picking: 58.5, packing: 99.2, tote: 7.8, share: 100 }, { semana: '2025-12-08', site: 'MLB', picking: 51.8, packing: 116.8, tote: 4.8, share: 100 }, { semana: '2025-12-08', site: 'MLC', picking: 84.2, packing: 172.1, tote: 4.5, share: 100 }, { semana: '2025-12-08', site: 'MLM', picking: 55.2, packing: 118.2, tote: 5.4, share: 100 }, { semana: '2025-12-08', site: 'Total', picking: 54.2, packing: 121.4, tote: 5.4, share: 100 },
      { semana: '2025-12-15', site: 'MCO', picking: 108.5, packing: 162.5, tote: 5.2, share: 100 }, { semana: '2025-12-15', site: 'MLA', picking: 54.2, packing: 92.1, tote: 6.5, share: 100 }, { semana: '2025-12-15', site: 'MLB', picking: 49.5, packing: 98.2, tote: 4.6, share: 47.2 }, { semana: '2025-12-15', site: 'MLC', picking: 82.1, packing: 158.2, tote: 4.8, share: 100 }, { semana: '2025-12-15', site: 'MLM', picking: 52.8, packing: 98.5, tote: 5.2, share: 47.2 }, { semana: '2025-12-15', site: 'Total', picking: 50.9, packing: 101.9, tote: 5.0, share: 47.2 },
      { semana: '2025-12-22', site: 'MCO', picking: 120.0, packing: 193.4, tote: 11.8, share: 100 }, { semana: '2025-12-22', site: 'MLA', picking: 61.9, packing: 103.1, tote: 7.8, share: 92.1 }, { semana: '2025-12-22', site: 'MLB', picking: 52.3, packing: 124.0, tote: 5.2, share: 65.4 }, { semana: '2025-12-22', site: 'MLC', picking: 78.9, packing: 164.4, tote: 5.9, share: 97.1 }, { semana: '2025-12-22', site: 'MLM', picking: 57.9, packing: 112.6, tote: 4.6, share: 77.5 }, { semana: '2025-12-22', site: 'Total', picking: 57.2, packing: 119.2, tote: 5.0, share: 74.0 },
      { semana: '2025-12-29', site: 'MCO', picking: 112.1, packing: 132.9, tote: 6.1, share: 100 }, { semana: '2025-12-29', site: 'MLA', picking: 69.8, packing: 114.5, tote: 12.2, share: 93.6 }, { semana: '2025-12-29', site: 'MLB', picking: 53.2, packing: 123.4, tote: 5.5, share: 59.0 }, { semana: '2025-12-29', site: 'MLC', picking: 78.5, packing: 141.4, tote: 2.5, share: 49.2 }, { semana: '2025-12-29', site: 'MLM', picking: 59.4, packing: 123.0, tote: 5.9, share: 76.2 }, { semana: '2025-12-29', site: 'Total', picking: 59.2, packing: 122.7, tote: 6.1, share: 70.1 },
      { semana: '2026-01-05', site: 'MCO', picking: null, packing: null, tote: 7.0, share: 78.8 }, { semana: '2026-01-05', site: 'MLA', picking: null, packing: null, tote: 16.4, share: 91.9 }, { semana: '2026-01-05', site: 'MLB', picking: null, packing: null, tote: 4.8, share: 72.2 }, { semana: '2026-01-05', site: 'MLC', picking: null, packing: null, tote: 3.7, share: 71.8 }, { semana: '2026-01-05', site: 'MLM', picking: null, packing: null, tote: 6.3, share: 67.5 }, { semana: '2026-01-05', site: 'Total', picking: null, packing: null, tote: 5.9, share: 71.0 },
      { semana: '2026-01-12', site: 'MCO', picking: null, packing: null, tote: 3.3, share: 100 }, { semana: '2026-01-12', site: 'MLA', picking: null, packing: null, tote: 6.5, share: 87.3 }, { semana: '2026-01-12', site: 'MLB', picking: null, packing: null, tote: 5.3, share: 72.5 }, { semana: '2026-01-12', site: 'MLC', picking: null, packing: null, tote: 3.0, share: 67.1 }, { semana: '2026-01-12', site: 'MLM', picking: null, packing: null, tote: 5.9, share: 65.4 }, { semana: '2026-01-12', site: 'Total', picking: null, packing: null, tote: 5.7, share: 69.9 },
      { semana: '2026-01-19', site: 'MCO', picking: 100.0, packing: 135.2, tote: 4.3, share: 100 }, { semana: '2026-01-19', site: 'MLA', picking: 54.3, packing: 97.6, tote: 7.4, share: 93.4 }, { semana: '2026-01-19', site: 'MLB', picking: 56.8, packing: 138.1, tote: 5.5, share: 68.0 }, { semana: '2026-01-19', site: 'MLC', picking: 94.2, packing: 190.6, tote: 6.7, share: 81.5 }, { semana: '2026-01-19', site: 'MLM', picking: 66.5, packing: 152.1, tote: 5.6, share: 64.8 }, { semana: '2026-01-19', site: 'Total', picking: 59.9, packing: 141.9, tote: 6.1, share: 68.1 },
      { semana: '2026-01-26', site: 'MCO', picking: 109.4, packing: 153.2, tote: 4.5, share: 68.6 }, { semana: '2026-01-26', site: 'MLA', picking: 47.4, packing: 78.1, tote: 6.5, share: 88.6 }, { semana: '2026-01-26', site: 'MLB', picking: 54.5, packing: 130.1, tote: 4.9, share: 72.4 }, { semana: '2026-01-26', site: 'MLC', picking: 97.1, packing: 187.2, tote: 7.6, share: 79.8 }, { semana: '2026-01-26', site: 'MLM', picking: 71.3, packing: 161.3, tote: 6.4, share: 64.1 }, { semana: '2026-01-26', site: 'Total', picking: 61.0, packing: 137.0, tote: 5.7, share: 70.2 },
      { semana: '2026-02-02', site: 'MCO', picking: 101.9, packing: 160.8, tote: 4.4, share: 100 }, { semana: '2026-02-02', site: 'MLA', picking: 53.9, packing: 81.4, tote: 5.3, share: 88.3 }, { semana: '2026-02-02', site: 'MLB', picking: 54.9, packing: 133.1, tote: 5.6, share: 70.4 }, { semana: '2026-02-02', site: 'MLC', picking: 111.4, packing: 215.3, tote: 15.9, share: 82.5 }, { semana: '2026-02-02', site: 'MLM', picking: 71.6, packing: 159.8, tote: 6.8, share: 59.7 }, { semana: '2026-02-02', site: 'Total', picking: 63.3, packing: 141.2, tote: 6.4, share: 68.0 },
      { semana: '2026-02-09', site: 'MCO', picking: 112.0, packing: 148.1, tote: 3.5, share: 99.3 }, { semana: '2026-02-09', site: 'MLA', picking: 48.7, packing: 83.1, tote: 4.0, share: 82.3 }, { semana: '2026-02-09', site: 'MLB', picking: 56.9, packing: 131.6, tote: 6.2, share: 80.4 }, { semana: '2026-02-09', site: 'MLC', picking: 92.9, packing: 197.9, tote: 2.6, share: 90.9 }, { semana: '2026-02-09', site: 'MLM', picking: 67.8, packing: 155.1, tote: 6.4, share: 48.2 }, { semana: '2026-02-09', site: 'Total', picking: 61.2, packing: 138.3, tote: 6.1, share: 70.3 }
    ];
    var historialMensual = [
      { mes: '2025-10-01', site: 'MCO', picking: 106.9, packing: 201.8, tote: 8.6, share: 100 }, { mes: '2025-10-01', site: 'MLA', picking: 55.5, packing: 102.0, tote: 5.8, share: 100 }, { mes: '2025-10-01', site: 'MLB', picking: 43.8, packing: 117.8, tote: 5.7, share: 100 }, { mes: '2025-10-01', site: 'MLC', picking: 84.5, packing: 155.8, tote: 5.3, share: 100 }, { mes: '2025-10-01', site: 'MLM', picking: 60.6, packing: 143.2, tote: 5.6, share: 100 }, { mes: '2025-10-01', site: 'Total', picking: 51.2, packing: 127.3, tote: 5.6, share: 100 },
      { mes: '2025-11-01', site: 'MCO', picking: 114.3, packing: 176.4, tote: 6.3, share: 100 }, { mes: '2025-11-01', site: 'MLA', picking: 57.5, packing: 101.6, tote: 5.2, share: 100 }, { mes: '2025-11-01', site: 'MLB', picking: 51.7, packing: 123.9, tote: 5.1, share: 100 }, { mes: '2025-11-01', site: 'MLC', picking: 97.8, packing: 175.1, tote: 6.8, share: 100 }, { mes: '2025-11-01', site: 'MLM', picking: 63.0, packing: 154.1, tote: 5.3, share: 100 }, { mes: '2025-11-01', site: 'Total', picking: 57.3, packing: 133.9, tote: 5.3, share: 100 },
      { mes: '2025-12-01', site: 'MCO', picking: 113.4, packing: 171.7, tote: 6.9, share: 95.3 }, { mes: '2025-12-01', site: 'MLA', picking: 58.3, packing: 101.4, tote: 7.7, share: 93.5 }, { mes: '2025-12-01', site: 'MLB', picking: 52.6, packing: 119.5, tote: 4.9, share: 74.9 }, { mes: '2025-12-01', site: 'MLC', picking: 85.9, packing: 171.5, tote: 4.8, share: 75.2 }, { mes: '2025-12-01', site: 'MLM', picking: 57.0, packing: 121.9, tote: 5.4, share: 66.7 }, { mes: '2025-12-01', site: 'Total', picking: 56.0, packing: 120.9, tote: 5.3, share: 72.9 },
      { mes: '2026-01-01', site: 'MCO', picking: 98.8, packing: 142.8, tote: 4.6, share: 94.9 }, { mes: '2026-01-01', site: 'MLA', picking: 49.4, packing: 94.9, tote: 9.6, share: 90.3 }, { mes: '2026-01-01', site: 'MLB', picking: 56.4, packing: 136.9, tote: 5.3, share: 69.9 }, { mes: '2026-01-01', site: 'MLC', picking: 88.8, packing: 186.4, tote: 5.3, share: 75.0 }, { mes: '2026-01-01', site: 'MLM', picking: 67.2, packing: 157.4, tote: 6.1, share: 65.8 }, { mes: '2026-01-01', site: 'Total', picking: 61.0, packing: 141.7, tote: 5.8, share: 69.7 },
      { mes: '2026-02-01', site: 'MCO', picking: 106.9, packing: 154.6, tote: 4.1, share: 89.8 }, { mes: '2026-02-01', site: 'MLA', picking: 50.3, packing: 80.4, tote: 5.7, share: 87.3 }, { mes: '2026-02-01', site: 'MLB', picking: 55.1, packing: 130.8, tote: 5.4, share: 74.0 }, { mes: '2026-02-01', site: 'MLC', picking: 101.6, packing: 202.2, tote: 10.2, share: 84.1 }, { mes: '2026-02-01', site: 'MLM', picking: 70.6, packing: 158.9, tote: 6.6, share: 58.6 }, { mes: '2026-02-01', site: 'Total', picking: 61.7, packing: 138.3, tote: 6.1, share: 69.4 }
    ];
    var SITES_ORDER = ['MLB','MLM','MLA','MLC','MCO','Total'];
    var MESES_CORTOS = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    var MESES_LARGOS = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
    var FECHA_POST_IMPLEMENTACION = '2026-01-19'; // lunes inicio post (desde 01/10/2025 = pre)
    function fechaFinPostLabel() {
      var d = new Date();
      return d.getDate() + ' ' + MESES_CORTOS[d.getMonth()] + ' ' + d.getFullYear();
    }
    function fmt(v) { return v == null || v === '' ? '—' : Number(v).toLocaleString('es-AR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }); }
    function fmtPct(v) { return v == null || v === '' ? '—' : fmt(v) + '%'; }
    function deltaClass(d) { if (d == null || d === '') return ''; return Number(d) >= 0 ? 'delta-pos' : 'delta-neg'; }
    function filtrarPorSiteYFC(arr, siteFilter, fcFilter) {
      if (!siteFilter && !fcFilter) return arr;
      return arr.filter(function(r) {
        var okSite = !siteFilter || r[0] === siteFilter;
        var okFC = !fcFilter || r[1] === fcFilter;
        return okSite && okFC;
      });
    }
    function buscarValorFC(arr, site, fc, indiceP3) {
      var r = arr.find(function(x) { return x[0] === site && x[1] === fc; });
      return r ? r[indiceP3] : null;
    }
    function valorParaAnio(arr, anio, idxP1, idxP2, idxP3) {
      if (anio === '2025') { var p1 = arr[idxP1], p2 = arr[idxP2]; return (p1 != null && p2 != null) ? (p1 + p2) / 2 : (p2 != null ? p2 : p1); }
      return arr[idxP3];
    }
    function updateKpiCards(siteFilter, fcFilter, anio) {
      anio = anio || (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      var scope = '';
      var picking, packing, tote, share;
      if (fcFilter) {
        var todos = datosPickingFC.concat(datosPackingFC).concat(datosToteFC).concat(datosShareFC);
        var s = siteFilter || (function() { for (var i = 0; i < todos.length; i++) if (todos[i][1] === fcFilter) return todos[i][0]; return ''; })();
        scope = ' · ' + (s || '') + ' ' + fcFilter;
        var rPick = datosPickingFC.find(function(x) { return x[0] === s && x[1] === fcFilter; });
        var rPack = datosPackingFC.find(function(x) { return x[0] === s && x[1] === fcFilter; });
        var rTote = datosToteFC.find(function(x) { return x[0] === s && x[1] === fcFilter; });
        var rShare = datosShareFC.find(function(x) { return x[0] === s && x[1] === fcFilter; });
        picking = rPick ? valorParaAnio(rPick, anio, 2, 3, 4) : null;
        packing = rPack ? valorParaAnio(rPack, anio, 2, 3, 4) : null;
        tote = rTote ? valorParaAnio(rTote, anio, 2, 3, 4) : null;
        share = rShare ? valorParaAnio(rShare, anio, 2, 3, 4) : null;
      } else {
        var siteKey = siteFilter || 'Total';
        scope = siteFilter ? ' · ' + siteFilter : ' · Total';
        var R = resumenSiteFull[siteKey] || resumenSiteFull.Total;
        picking = R ? valorParaAnio(R.picking, anio, 0, 1, 2) : null;
        packing = R ? valorParaAnio(R.packing, anio, 0, 1, 2) : null;
        tote = R ? valorParaAnio(R.tote, anio, 0, 1, 2) : null;
        share = R ? valorParaAnio(R.share, anio, 0, 1, 2) : null;
      }
      document.getElementById('kpi-picking').textContent = picking != null ? fmt(picking) : '—';
      document.getElementById('kpi-packing').textContent = packing != null ? fmt(packing) : '—';
      document.getElementById('kpi-tote').textContent = tote != null ? fmt(tote) : '—';
      document.getElementById('kpi-share').textContent = share != null ? fmt(share) + '%' : '—';
      document.getElementById('kpi-picking-label').textContent = 'Productividad efectiva (Picking)' + scope + ' · ' + anio;
      document.getElementById('kpi-packing-label').textContent = 'Productividad efectiva (Packing)' + scope + ' · ' + anio;
      document.getElementById('kpi-tote-label').textContent = 'Piezas por Tote (#unidades/#totes)' + scope + ' · ' + anio;
      document.getElementById('kpi-share-label').textContent = 'Share Retiros' + scope + ' · ' + anio;
    }
    function renderResumenTable(anio, siteFilter) {
      anio = anio || (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      siteFilter = siteFilter || '';
      var thead = document.getElementById('tabla-kpis-thead');
      var tbody = document.getElementById('tabla-kpis-body');
      var sites = siteFilter ? SITES_ORDER.filter(function(s) { return s === siteFilter || s === 'Total'; }) : SITES_ORDER.slice();
      var headerHtml, fila = function(site, kpi, vals, esPct) {
        var trClass = (site === 'Total') ? ' class="total-row"' : '';
        var v0 = esPct ? fmtPct(vals[0]) : fmt(vals[0]), v1 = esPct ? fmtPct(vals[1]) : fmt(vals[1]), v2 = esPct ? fmtPct(vals[2]) : fmt(vals[2]);
        var d21 = vals[0] != null && vals[1] != null ? (vals[1] - vals[0]) / vals[0] * 100 : null;
        var d32 = vals[1] != null && vals[2] != null ? (vals[2] - vals[1]) / vals[1] * 100 : null;
        var d31 = vals[0] != null && vals[2] != null ? (vals[2] - vals[0]) / vals[0] * 100 : null;
        if (anio === '2025') return '<tr' + trClass + '><td>' + site + '</td><td class="num">' + v0 + '</td><td class="num">' + v1 + '</td><td class="num delta-col ' + deltaClass(d21) + '">' + (d21 != null ? fmt(d21) + '%' : '—') + '</td></tr>';
        if (anio === '2026') return '<tr' + trClass + '><td>' + site + '</td><td class="num">' + v2 + '</td></tr>';
        return '<tr' + trClass + '><td>' + site + '</td><td class="num">' + v0 + '</td><td class="num">' + v1 + '</td><td class="num">' + v2 + '</td><td class="num delta-col ' + deltaClass(d31) + '">' + (d31 != null ? fmt(d31) + '%' : '—') + '</td><td class="num delta-col ' + deltaClass(d32) + '">' + (d32 != null ? fmt(d32) + '%' : '—') + '</td></tr>';
      };
      if (anio === '2025') headerHtml = '<tr><th>Site</th><th class="num th-period">Pre-implemen<br>(01 Oct - 30 Nov 2025)</th><th class="num th-period">Pre-implemen<br>(01-31 Dic 2025)</th><th class="num delta-col">Delta Dic vs Oct+Nov</th></tr>';
      else if (anio === '2026') headerHtml = '<tr><th>Site</th><th class="num th-period">Post-implemen<br>(19 Ene - ' + fechaFinPostLabel() + ')</th></tr>';
      else headerHtml = '<tr><th>Site</th><th class="num th-period">Pre-implemen<br>(01 Oct - 30 Nov 2025)</th><th class="num th-period">Pre-implemen<br>(01-31 Dic 2025)</th><th class="num th-period">Post-implemen<br>(19 Ene - ' + fechaFinPostLabel() + ')</th><th class="num delta-col">Delta vs Oct+Nov</th><th class="num delta-col">Delta vs Dic</th></tr>';
      thead.innerHTML = headerHtml;
      var html = '';
      ['picking','packing','tote','share'].forEach(function(kpiName, idx) {
        var nombres = { picking: 'Productividad efectiva (Picking)', packing: 'Productividad efectiva (Packing)', tote: 'Piezas por Tote', share: 'Share Retiros' };
        var esPct = kpiName === 'share';
        var colSpan = anio === '2025' ? 4 : anio === '2026' ? 2 : 6;
        html += '<tr class="kpi-group"><td colspan="' + colSpan + '">' + nombres[kpiName] + '</td></tr>';
        for (var i = 0; i < sites.length; i++) {
          var s = sites[i], R = resumenSiteFull[s];
          if (!R) continue;
          html += fila(s, kpiName, R[kpiName], esPct);
        }
      });
      tbody.innerHTML = html;
    }
    function renderTablaFC(siteFilter, fcFilter, anio) {
      anio = anio || (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      siteFilter = siteFilter || '';
      fcFilter = fcFilter || '';
      var pick = filtrarPorSiteYFC(datosPickingFC, siteFilter, fcFilter);
      var pack = filtrarPorSiteYFC(datosPackingFC, siteFilter, fcFilter);
      var tote = filtrarPorSiteYFC(datosToteFC, siteFilter, fcFilter);
      var share = filtrarPorSiteYFC(datosShareFC, siteFilter, fcFilter);
      var thead = document.getElementById('tabla-fc-thead');
      var tbody = document.getElementById('tabla-fc-body');
      var nCol = anio === '2025' ? 5 : anio === '2026' ? 3 : 7;
      var labelPost = '19 Ene - ' + fechaFinPostLabel();
      var headerRowFC = anio === '2025' ? '<tr class="row-header"><th>Site</th><th>FC</th><th class="num th-period">Pre-implemen<br>(01 Oct - 30 Nov 2025)</th><th class="num th-period">Pre-implemen<br>(01-31 Dic 2025)</th><th class="num delta-col">Delta Dic vs Oct+Nov</th></tr>' : anio === '2026' ? '<tr class="row-header"><th>Site</th><th>FC</th><th class="num th-period">Post-implemen<br>(' + labelPost + ')</th></tr>' : '<tr class="row-header"><th>Site</th><th>FC</th><th class="num th-period">Pre-implemen<br>(01 Oct - 30 Nov 2025)</th><th class="num th-period">Pre-implemen<br>(01-31 Dic 2025)</th><th class="num th-period">Post-implemen<br>(' + labelPost + ')</th><th class="num delta-col">Delta vs Oct+Nov</th><th class="num delta-col">Delta vs Dic</th></tr>';
      function filas(data, esPct) {
        var out = '';
        for (var i = 0; i < data.length; i++) {
          var r = data[i], site = r[0], fc = r[1], p1 = r[2], p2 = r[3], p3 = r[4], d1 = r[5], d2 = r[6];
          var v1 = esPct ? fmtPct(p1) : fmt(p1), v2 = esPct ? fmtPct(p2) : fmt(p2), v3 = esPct ? fmtPct(p3) : fmt(p3);
          var d21 = (p1 != null && p2 != null) ? (p2 - p1) / p1 * 100 : null;
          if (anio === '2025') { out += '<tr><td>' + site + '</td><td>' + fc + '</td><td class="num">' + v1 + '</td><td class="num">' + v2 + '</td><td class="num delta-col ' + deltaClass(d21) + '">' + (d21 != null ? fmt(d21) + '%' : '—') + '</td></tr>'; continue; }
          if (anio === '2026') { out += '<tr><td>' + site + '</td><td>' + fc + '</td><td class="num">' + v3 + '</td></tr>'; continue; }
          var dd1 = d1 != null ? fmt(d1) + '%' : '—', dd2 = d2 != null ? fmt(d2) + '%' : '—';
          out += '<tr><td>' + site + '</td><td>' + fc + '</td><td class="num">' + v1 + '</td><td class="num">' + v2 + '</td><td class="num">' + v3 + '</td><td class="num ' + deltaClass(d1) + '">' + dd1 + '</td><td class="num ' + deltaClass(d2) + '">' + dd2 + '</td></tr>';
        }
        return out;
      }
      var html = '';
      html += '<tr class="kpi-group"><td colspan="' + nCol + '">Productividad efectiva (Picking) · por FC</td></tr>' + filas(pick, false);
      html += (anio === '2025' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">53,8</td><td class="num">56</td><td class="num">—</td></tr>' : anio === '2026' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">61,4</td></tr>' : '<tr class="total-row"><td>Total</td><td>—</td><td class="num">53,8</td><td class="num">56</td><td class="num">61,4</td><td class="num delta-pos">14,1%</td><td class="num delta-pos">9,6%</td></tr>');
      html += headerRowFC + '<tr class="kpi-group"><td colspan="' + nCol + '">Productividad efectiva (Packing) · por FC</td></tr>' + filas(pack, false);
      html += (anio === '2025' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">130,1</td><td class="num">120,9</td><td class="num">—</td></tr>' : anio === '2026' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">139,8</td></tr>' : '<tr class="total-row"><td>Total</td><td>—</td><td class="num">130,1</td><td class="num">120,9</td><td class="num">139,8</td><td class="num delta-pos">7,5%</td><td class="num delta-pos">15,6%</td></tr>');
      html += headerRowFC + '<tr class="kpi-group"><td colspan="' + nCol + '">Piezas por Tote (#unidades/#totes)</td></tr>' + filas(tote, false);
      html += (anio === '2025' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">5,5</td><td class="num">5,2</td><td class="num">—</td></tr>' : anio === '2026' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">6</td></tr>' : '<tr class="total-row"><td>Total</td><td>—</td><td class="num">5,5</td><td class="num">5,2</td><td class="num">6</td><td class="num delta-pos">9,1%</td><td class="num delta-pos">15,4%</td></tr>');
      html += headerRowFC + '<tr class="kpi-group"><td colspan="' + nCol + '">Share Retiros · por FC</td></tr>' + filas(share, true);
      html += (anio === '2025' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">100%</td><td class="num">72,9%</td><td class="num">—</td></tr>' : anio === '2026' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">69,2%</td></tr>' : '<tr class="total-row"><td>Total</td><td>—</td><td class="num">100%</td><td class="num">72,9%</td><td class="num">69,2%</td><td class="num delta-neg">-30,8%</td><td class="num delta-neg">-5,1%</td></tr>');
      thead.innerHTML = headerRowFC;
      tbody.innerHTML = html;
    }
    function periodoDeFila(r) { return r.periodo || r.semana || r.mes || ''; }
    function formatearLunes(semanaStr) {
      if (!semanaStr || String(semanaStr).length < 10) return '—';
      var s = String(semanaStr);
      var d = parseInt(s.substring(8, 10), 10), m = parseInt(s.substring(5, 7), 10) - 1;
      return d + ' ' + (MESES_LARGOS[m] || '');
    }
    function buildWeekLabels(semanasUnicas, esPre) {
      var map = {};
      semanasUnicas.sort();
      for (var i = 0; i < semanasUnicas.length; i++)
        map[semanasUnicas[i]] = 'Week ' + (i + 1) + ' (' + formatearLunes(semanasUnicas[i]) + ')';
      return map;
    }
    function filtrarHistorial(datos, anio, siteFilter) {
      if (!datos || !datos.length) return [];
      return datos.filter(function(r) {
        var p = periodoDeFila(r);
        var okAnio = anio === 'Todos' || (p && String(p).substring(0, 4) === anio);
        var okSite = !siteFilter || r.site === siteFilter;
        return okAnio && okSite;
      });
    }
    function formatearPeriodo(periodoStr, esSemana) {
      if (!periodoStr) return '—';
      var s = String(periodoStr);
      if (s.length >= 10) {
        var y = s.substring(0, 4), m = parseInt(s.substring(5, 7), 10) - 1, d = s.substring(8, 10);
        return d + ' ' + MESES_CORTOS[m] + ' ' + y;
      }
      return s;
    }
    function formatearSoloMes(periodoStr) {
      if (!periodoStr || String(periodoStr).length < 7) return '—';
      var s = String(periodoStr);
      var y = s.substring(0, 4), m = parseInt(s.substring(5, 7), 10) - 1;
      return MESES_CORTOS[m] + ' ' + y;
    }
    function renderHistorial() {
      var tbody = document.getElementById('tabla-historial-body');
      var thead = document.getElementById('tabla-historial-thead');
      if (!tbody) return;
      var dimension = (document.getElementById('historial-dimension') && document.getElementById('historial-dimension').value) || 'semana';
      var anio = (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      var siteFilter = (document.getElementById('site') && document.getElementById('site').value) || '';
      var datos = dimension === 'mes' ? filtrarHistorial(historialMensual, anio, siteFilter) : filtrarHistorial(historialSemanal, anio, siteFilter);
      if (thead) thead.innerHTML = dimension === 'mes' ? '<tr><th>Mes</th><th>Site</th><th class="num">Picking</th><th class="num">Packing</th><th class="num">Unit/Tote</th><th class="num">Share %</th></tr>' : '<tr><th>Periodo</th><th>Site</th><th class="num">Picking</th><th class="num">Packing</th><th class="num">Unit/Tote</th><th class="num">Share %</th></tr>';
      var html = '';
      if (dimension === 'semana') {
        var pre = datos.filter(function(r) { var p = r.semana || ''; return p < FECHA_POST_IMPLEMENTACION; });
        var post = datos.filter(function(r) { var p = r.semana || ''; return p >= FECHA_POST_IMPLEMENTACION; });
        var preSemanas = [], postSemanas = [];
        pre.forEach(function(r) { if (r.semana && preSemanas.indexOf(r.semana) === -1) preSemanas.push(r.semana); });
        post.forEach(function(r) { if (r.semana && postSemanas.indexOf(r.semana) === -1) postSemanas.push(r.semana); });
        var labelPre = buildWeekLabels(preSemanas, true), labelPost = buildWeekLabels(postSemanas, false);
        var SITES_SIN_TOTAL = ['MLB','MLM','MLA','MLC','MCO'];
        function filasPorSemana(arr, labelMap) {
          var out = '';
          var semanas = Object.keys(labelMap).sort();
          for (var s = 0; s < semanas.length; s++) {
            var sem = semanas[s];
            var periodoLabel = labelMap[sem];
            var filasSem = arr.filter(function(r) { return r.semana === sem; });
            var totalRow = filasSem.filter(function(r) { return r.site === 'Total'; })[0];
            var detalleRows = SITES_SIN_TOTAL.map(function(site) { return filasSem.filter(function(r) { return r.site === site; })[0]; }).filter(Boolean);
            var primeraFilaConLabel = true;
            if (totalRow) {
              out += '<tr class="total-row"><td>' + periodoLabel + '</td><td>Total</td><td class="num">' + fmt(totalRow.picking) + '</td><td class="num">' + fmt(totalRow.packing) + '</td><td class="num">' + fmt(totalRow.tote) + '</td><td class="num">' + fmtPct(totalRow.share) + '</td></tr>';
              primeraFilaConLabel = false;
            }
            for (var d = 0; d < detalleRows.length; d++) {
              var r = detalleRows[d];
              out += '<tr><td>' + (primeraFilaConLabel ? periodoLabel : '') + '</td><td>' + (r.site || '—') + '</td><td class="num">' + fmt(r.picking) + '</td><td class="num">' + fmt(r.packing) + '</td><td class="num">' + fmt(r.tote) + '</td><td class="num">' + fmtPct(r.share) + '</td></tr>';
              if (primeraFilaConLabel) primeraFilaConLabel = false;
            }
          }
          return out;
        }
        if (pre.length) {
          html += '<tr class="historial-seccion"><td colspan="6">Pre implementación</td></tr>';
          html += filasPorSemana(pre, labelPre);
        }
        if (post.length) {
          html += '<tr class="historial-seccion"><td colspan="6">Post implementación</td></tr>';
          html += filasPorSemana(post, labelPost);
        }
      } else {
        var preMes = datos.filter(function(r) { var p = r.mes || ''; return p < '2026-01-01'; });
        var postMes = datos.filter(function(r) { var p = r.mes || ''; return p >= '2026-01-01'; });
        var SITES_SIN_TOTAL = ['MLB','MLM','MLA','MLC','MCO'];
        function filasPorMes(arr) {
          var meses = [];
          arr.forEach(function(r) { if (r.mes && meses.indexOf(r.mes) === -1) meses.push(r.mes); });
          meses.sort();
          var out = '';
          for (var m = 0; m < meses.length; m++) {
            var mesVal = meses[m];
            var periodoLabel = formatearSoloMes(mesVal);
            var filasMes = arr.filter(function(r) { return r.mes === mesVal; });
            var totalRow = filasMes.filter(function(r) { return r.site === 'Total'; })[0];
            var detalleRows = SITES_SIN_TOTAL.map(function(site) { return filasMes.filter(function(r) { return r.site === site; })[0]; }).filter(Boolean);
            var primeraFilaConLabel = true;
            if (totalRow) {
              out += '<tr class="total-row"><td>' + periodoLabel + '</td><td>Total</td><td class="num">' + fmt(totalRow.picking) + '</td><td class="num">' + fmt(totalRow.packing) + '</td><td class="num">' + fmt(totalRow.tote) + '</td><td class="num">' + fmtPct(totalRow.share) + '</td></tr>';
              primeraFilaConLabel = false;
            }
            for (var d = 0; d < detalleRows.length; d++) {
              var r = detalleRows[d];
              out += '<tr><td>' + (primeraFilaConLabel ? periodoLabel : '') + '</td><td>' + (r.site || '—') + '</td><td class="num">' + fmt(r.picking) + '</td><td class="num">' + fmt(r.packing) + '</td><td class="num">' + fmt(r.tote) + '</td><td class="num">' + fmtPct(r.share) + '</td></tr>';
              if (primeraFilaConLabel) primeraFilaConLabel = false;
            }
          }
          return out;
        }
        if (preMes.length) {
          html += '<tr class="historial-seccion"><td colspan="6">Pre implementación</td></tr>';
          html += filasPorMes(preMes);
        }
        if (postMes.length) {
          html += '<tr class="historial-seccion"><td colspan="6">Post implementación</td></tr>';
          html += filasPorMes(postMes);
        }
      }
      if (!html) html = '<tr><td colspan="6">Sin datos. Ejecute query_historial_semanal_site.sql y query_historial_mensual_site.sql y cargue historialSemanal e historialMensual.</td></tr>';
      tbody.innerHTML = html;
    }
    function aplicarFiltros() {
      var anio = (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      var site = document.getElementById('site').value;
      var fc = document.getElementById('fc').value;
      var todosLosFC = datosPickingFC.concat(datosPackingFC).concat(datosToteFC).concat(datosShareFC);
      var sitioDelFC = null;
      if (fc) { for (var k = 0; k < todosLosFC.length; k++) { if (todosLosFC[k][1] === fc) { sitioDelFC = todosLosFC[k][0]; break; } } }
      var siteParaResumen = site || sitioDelFC;
      updateKpiCards(site, fc, anio);
      renderResumenTable(anio, siteParaResumen);
      renderTablaFC(site, fc, anio);
      renderHistorial();
    }
    function llenarFiltroFC(siteFilter) {
      var todos = datosPickingFC.concat(datosPackingFC).concat(datosToteFC).concat(datosShareFC);
      var unicos = {};
      for (var i = 0; i < todos.length; i++) {
        var s = todos[i][0], f = todos[i][1];
        if (siteFilter && s !== siteFilter) continue;
        if (!unicos[f]) unicos[f] = s;
      }
      var fcs = Object.keys(unicos).sort();
      var sel = document.getElementById('fc');
      var valorActual = sel.value;
      sel.innerHTML = '<option value="">Todos</option>';
      for (var j = 0; j < fcs.length; j++) {
        var opt = document.createElement('option');
        opt.value = fcs[j];
        opt.textContent = fcs[j];
        sel.appendChild(opt);
      }
      if (valorActual && fcs.indexOf(valorActual) !== -1) sel.value = valorActual;
    }
    function fechaHoy() {
      var d = new Date();
      return ('0' + d.getDate()).slice(-2) + '/' + ('0' + (d.getMonth() + 1)).slice(-2) + '/' + d.getFullYear();
    }
    document.addEventListener('DOMContentLoaded', function() {
      var hoy = fechaHoy();
      var elNota = document.getElementById('fecha-hoy-nota');
      var elFooter = document.getElementById('fecha-hoy-footer');
      if (elNota) elNota.textContent = hoy;
      if (elFooter) elFooter.textContent = hoy;
      var anio = (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      llenarFiltroFC('');
      renderResumenTable(anio, '');
      renderTablaFC('', '', anio);
      updateKpiCards('', '', anio);
      renderHistorial();
      document.getElementById('anio').addEventListener('change', aplicarFiltros);
      document.getElementById('site').addEventListener('change', function() { llenarFiltroFC(this.value); aplicarFiltros(); });
      document.getElementById('fc').addEventListener('change', aplicarFiltros);
      var dimEl = document.getElementById('historial-dimension');
      if (dimEl) dimEl.addEventListener('change', function() { renderHistorial(); });
    });
    function descargarCSV() {
      var table = document.getElementById('tabla-kpis');
      var rows = table.querySelectorAll('tr');
      var csv = [];
      for (var i = 0; i < rows.length; i++) {
        var cells = rows[i].querySelectorAll('th, td');
        var row = [];
        for (var j = 0; j < cells.length; j++) row.push('"' + (cells[j].textContent || '').trim().replace(/"/g, '""') + '"');
        csv.push(row.join(','));
      }
      var table2 = document.getElementById('tabla-fc');
      if (table2) {
        var rows2 = table2.querySelectorAll('tr');
        for (var i = 0; i < rows2.length; i++) {
          var cells = rows2[i].querySelectorAll('th, td');
          var row = [];
          for (var j = 0; j < cells.length; j++) row.push('"' + (cells[j].textContent || '').trim().replace(/"/g, '""') + '"');
          csv.push(row.join(','));
        }
      }
      var blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'kpis_pre_post_centralizacion_' + new Date().toISOString().slice(0,10) + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }
  </script>
</body>
</html>
