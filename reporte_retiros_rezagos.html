<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Report Scorecard Retiros y Rezagos</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #fff;
      color: #333;
      margin: 0;
      padding: 24px;
      line-height: 1.5;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 {
      color: #ffe600;
      background: #3483fa;
      margin: -24px -24px 24px -24px;
      padding: 20px 24px;
      font-size: 1.5rem;
      font-weight: 700;
    }
    h2 {
      color: #3483fa;
      font-size: 1.2rem;
      margin-top: 32px;
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 2px solid #ffe600;
    }
    /* Filtros */
    .filtros {
      background: #f5f5f5;
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      align-items: end;
    }
    .filtros label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: #666;
      margin-bottom: 6px;
    }
    .filtros select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
      background: #fff;
    }
    .filtros select:focus {
      outline: none;
      border-color: #3483fa;
      box-shadow: 0 0 0 2px rgba(52, 131, 250, 0.2);
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary {
      background: #3483fa;
      color: #fff;
    }
    .btn-primary:hover { background: #2968c8; }
    .btn-secondary {
      background: #fff;
      color: #3483fa;
      border: 1px solid #3483fa;
    }
    .btn-secondary:hover { background: #f0f7ff; }
    /* KPIs destacados */
    .kpi {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }
    .kpi-card {
      background: #f5f5f5;
      border-left: 4px solid #3483fa;
      padding: 16px 20px;
      min-width: 140px;
      border-radius: 4px;
    }
    .kpi-card .value { font-size: 1.75rem; font-weight: 700; color: #333; }
    .kpi-card .label { font-size: 0.85rem; color: #666; margin-top: 4px; }
    /* Tabla principal */
    .tabla-wrap { overflow-x: auto; margin-bottom: 24px; max-width: 100%; }
    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      font-size: 0.85rem;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
      border-radius: 4px;
      overflow: hidden;
    }
    th, td { padding: 8px 6px; text-align: center; }
    th {
      background: #3483fa;
      color: #fff;
      font-weight: 600;
    }
    th.th-period { white-space: normal; line-height: 1.2; text-align: center; word-break: break-word; }
    th.num, td.num { text-align: center; font-variant-numeric: tabular-nums; }
    /* Resumen por Site: 6 columnas */
    #tabla-kpis th:nth-child(1), #tabla-kpis td:nth-child(1) { width: 10%; }
    #tabla-kpis th:nth-child(2), #tabla-kpis th:nth-child(3), #tabla-kpis th:nth-child(4),
    #tabla-kpis td:nth-child(2), #tabla-kpis td:nth-child(3), #tabla-kpis td:nth-child(4) { width: 18%; }
    #tabla-kpis th:nth-child(5), #tabla-kpis th:nth-child(6), #tabla-kpis td:nth-child(5), #tabla-kpis td:nth-child(6) { width: 14%; }
    /* Detalle por FC: 7 columnas */
    #tabla-fc th:nth-child(1), #tabla-fc td:nth-child(1) { width: 8%; }
    #tabla-fc th:nth-child(2), #tabla-fc td:nth-child(2) { width: 7%; }
    #tabla-fc th:nth-child(3), #tabla-fc th:nth-child(4), #tabla-fc th:nth-child(5),
    #tabla-fc td:nth-child(3), #tabla-fc td:nth-child(4), #tabla-fc td:nth-child(5) { width: 17%; }
    #tabla-fc th:nth-child(6), #tabla-fc th:nth-child(7), #tabla-fc td:nth-child(6), #tabla-fc td:nth-child(7) { width: 13%; }
    tr:nth-child(even) { background: #f9f9f9; }
    tr.row-header th { background: #3483fa; color: #fff; font-weight: 700; }
    tr:hover { background: #f0f7ff; }
    tr.kpi-group { font-weight: 600; background: #e8f0fe; }
    tr.total-row { font-weight: 700; background: #e8f0fe; }
    tr.total-row td { font-weight: 700; }
    .delta-pos { color: #00a650; }
    .delta-neg { color: #f23d4f; }
    .note { font-size: 0.9rem; color: #666; margin-bottom: 16px; }
    .footer {
      margin-top: 40px;
      padding-top: 16px;
      border-top: 1px solid #eee;
      font-size: 0.8rem;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Daily Report Scorecard Retiros y Rezagos</h1>
    <p class="note">Datos desde <strong>01/10/2025</strong> hasta el <strong id="fecha-hoy-nota"></strong> (fecha de actualización). Períodos: Pre (01 Oct-30 Nov), Pre (01-31 Dic), Post (19 Ene - <span id="fecha-fin-post-nota"></span>).</p>

    <!-- Filtros: Año, Site, FC -->
    <h2>Filtros</h2>
    <div class="filtros">
      <div>
        <label for="anio">Año</label>
        <select id="anio">
          <option value="Todos">Todos</option>
          <option value="2025">2025</option>
          <option value="2026">2026</option>
        </select>
      </div>
      <div>
        <label for="site">Site / País</label>
        <select id="site">
          <option value="">Todos</option>
          <option value="MLB">MLB</option>
          <option value="MLM">MLM</option>
          <option value="MLA">MLA</option>
          <option value="MLC">MLC</option>
          <option value="MCO">MCO</option>
        </select>
      </div>
      <div>
        <label for="fc">FC</label>
        <select id="fc"><option value="">Todos</option></select>
      </div>
      <div style="display: flex; gap: 8px;">
        <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">Aplicar</button>
        <button type="button" class="btn btn-secondary" onclick="descargarCSV()">Descargar CSV</button>
      </div>
    </div>

    <h2>Resumen KPIs</h2>
    <p class="note">Todo el dashboard (tarjetas, Resumen por Site y Detalle por FC) cambia según los filtros Año, Site y FC.</p>
    <div class="kpi" id="kpi-cards">
      <div class="kpi-card">
        <div class="value" id="kpi-picking">60,8</div>
        <div class="label" id="kpi-picking-label">Productividad efectiva (Picking)</div>
      </div>
      <div class="kpi-card">
        <div class="value" id="kpi-packing">139,7</div>
        <div class="label" id="kpi-packing-label">Productividad efectiva (Packing)</div>
      </div>
      <div class="kpi-card">
        <div class="value" id="kpi-tote">12,2</div>
        <div class="label" id="kpi-tote-label">Piezas por Tote (#unidades/#totes)</div>
      </div>
      <div class="kpi-card">
        <div class="value" id="kpi-share">35,4%</div>
        <div class="label" id="kpi-share-label">Share Retiros</div>
      </div>
    </div>

    <h2>Resumen por Site</h2>
    <div class="tabla-wrap">
      <table id="tabla-kpis">
        <thead id="tabla-kpis-thead"><tr><th>Site</th></tr></thead>
        <tbody id="tabla-kpis-body"></tbody>
      </table>
    </div>

    <h2>Detalle por FC (centro logístico)</h2>
    <div class="tabla-wrap">
      <table id="tabla-fc">
        <thead id="tabla-fc-thead"><tr><th>Site</th><th>FC</th></tr></thead>
        <tbody id="tabla-fc-body"></tbody>
      </table>
    </div>

    <h2>Lógica de métricas</h2>
    <div class="note" style="margin-bottom: 24px;">
      <strong>Pre-implementación (P1: 01 Oct–30 Nov 2025; P2: 01–31 Dic 2025):</strong> solo procesos <em>withdrawals</em> (retiros).<br>
      <strong>Post-implementación (P3: 19 Ene – <span id="fecha-fin-post-texto"></span>):</strong> desde el <strong>19/01/2026</strong> se suman los procesos <em>disposal</em>. La fecha de fin del post es la del día de la última actualización.<br><br>
      <strong>Resumen por métrica (filtros y fórmula):</strong><br>
      • <strong>Productividad efectiva (Picking):</strong> solo procesos <em>picking</em>. Pre: picking_withdrawals. Post: picking_withdrawals + picking_disposal. Fórmula: SUM(UNITS)/SUM(P_TIME).<br>
      • <strong>Productividad efectiva (Packing):</strong> solo procesos <em>packing</em>. Pre: packing_withdrawals. Post: packing_withdrawals + packing_disposal. Fórmula: SUM(UNITS)/SUM(P_TIME).<br>
      • <strong>Piezas por Tote:</strong> #unidades/#totes. Filtro Process Path: solo rutas con PP_WITHDRAWAL_SINGLE_SKU, PP_WITHDRAWAL_DIRECT_PACKING, PP_WITHDRAWAL_SORT. Fórmula: SUM(UNIT_QTY_PICKED)/SUM(TOTES_PER_CART_USED).<br>
      • <strong>Share Retiros:</strong> solo procesos <em>packing</em> (packing_withdrawals, packing_disposal). Share % = 100×Withdrawals/(Withdrawals+Disposal). Antes de ~9 Dic no había disposal → 100%.
    </div>

    <h2>Fuentes de datos</h2>
    <div class="footer">
      <strong>Tablas principales (BigQuery, proyecto meli-bi-data):</strong><br>
      • <strong>SBOX_REVERSA.REMOVALS_PRODUCTIVITY_AREA</strong> — Productividad efectiva (Picking y Packing), WAREHOUSE = FC.<br>
      • <strong>SBOX_REVERSA.RETURNS_NP_OUT</strong> — Share Retiros, LOGISTIC_CENTER_ID = FC.<br>
      • <strong>WHOWNER.LK_SOT_PICKING_MAIN_TABLE</strong> — Piezas por Tote: SUM(UNIT_QTY_PICKED)/SUM(TOTES_PER_CART_USED).<br>
      Datos desde 01/10/2025 hasta el <span id="fecha-hoy-footer"></span> (actualización diaria).
    </div>
  </div>

  <script>
    // Picking: datos reales BigQuery RETURNS_NP_OUT. Pre: picking_withdrawals; Post: picking_withdrawals + picking_disposal (impl. 19/01/2026).
    var datosPickingFC = [["MCO","COCU02",110.2,113.4,103.2,-6.3,-9],["MLA","ARBA01",56.4,58.3,50.5,-10.5,-13.5],["MLA","ARBA02",11.8,48.3,27.8,135.8,-42.5],["MLA","ARBA04",39.9,61.3,27.7,-30.6,-54.8],["MLB","BRBA01",53.4,50.5,55.1,3.2,9.2],["MLB","BRBA02",19.8,34,27.9,41.2,-17.9],["MLB","BRDF01",58.7,50.4,75.3,28.2,49.5],["MLB","BRMG01",37.7,42.7,56.8,50.7,33],["MLB","BRMG02",64.2,129.6,77.1,20.2,-40.5],["MLB","BRMG03",34.1,21.8,49.1,43.9,125.7],["MLB","BRMG04",0,0,61.9,null,null],["MLB","BRPE01",61.3,60.4,56.2,-8.3,-7],["MLB","BRPR01",30.9,32.2,41.1,32.8,27.7],["MLB","BRRC01",101.4,93.9,119.6,17.9,27.4],["MLB","BRRC02",43,44.8,72.6,68.9,61.8],["MLB","BRRC03",67.6,75.3,112.4,66.3,49.3],["MLB","BRRJ02",48.2,49.4,47.7,-1.1,-3.5],["MLB","BRRS01",74,67.8,54,-27,-20.3],["MLB","BRSC02",59.9,63,58.6,-2.2,-7],["MLB","BRSP02",34.3,36.6,41,19.4,12.2],["MLB","BRSP04",52.7,69.7,64.8,22.9,-7.1],["MLB","BRSP06",97.9,94.7,87.3,-10.8,-7.8],["MLB","BRSP09",27.4,12.9,25.8,-6.1,100.3],["MLB","BRSP10",44.3,52.3,40.3,-8.9,-22.9],["MLB","BRSP11",62.3,49.1,43.1,-30.7,-12.1],["MLB","BRSP14",60.1,63.4,70.9,17.9,11.7],["MLB","BRSP15",60.9,59.1,58.6,-3.9,-1],["MLB","BRSP18",68.2,68.6,71.5,4.8,4.2],["MLB","BRSP19",72.7,72.1,78.8,8.4,9.3],["MLB","BRSP24",41.2,36.9,52.1,26.5,41.1],["MLB","BRSP25",28.6,53.1,92,222.2,73.1],["MLB","SSP21",0,null,null,null,null],["MLC","CLBB01",45,52.2,61.5,36.7,17.7],["MLC","CLRM03",91.2,85.9,97.1,6.5,13],["MLM","MXCD02",60.9,64.6,79.8,31,23.4],["MLM","MXCD05",39.2,40.1,39.1,0,-2.3],["MLM","MXCD06",165.1,143.2,150.8,-8.6,5.3],["MLM","MXCD07",78,62.4,80.5,3.1,29],["MLM","MXCD08",2.9,11.4,24,716.6,111],["MLM","MXCD09",43.6,35.7,40.7,-6.6,14.2],["MLM","MXCD10",79.6,78.4,110.8,39.1,41.4],["MLM","MXCD11",64.5,65.4,67.1,4,2.6],["MLM","MXCD12",30.7,23.9,23.5,-23.5,-1.7],["MLM","MXCD14",null,null,2,null,null],["MLM","MXGT01",58.8,48.5,61.2,4,26],["MLM","MXJC01",78.6,68.6,76,-3.3,10.8],["MLM","MXNL01",60.6,56.8,76.5,26.2,34.5],["MLM","MXRC03",115.9,77.1,102.7,-11.4,33.2],["MLM","MXSO01",41.9,67,71.2,69.8,6.2],["MLM","MXYU01",63.2,65.6,67.5,6.8,2.8],["MLM","USTX01",218.3,140.3,203.3,-6.8,44.9]];
    // Packing: datos reales BigQuery RETURNS_NP_OUT. Pre: packing_withdrawals; Post: + packing_disposal (impl. 19/01/2026).
    var datosPackingFC = [["MCO","COCU02",189.1,171.7,148.8,-21.3,-13.3],["MLA","ARBA01",102,102.2,88.6,-13.1,-13.3],["MLA","ARBA02",25,27.8,28.7,14.8,3.5],["MLA","ARBA04",32.1,42.8,62.9,95.8,46.9],["MLB","BRBA01",174,151.2,178.4,2.6,18],["MLB","BRBA02",55.9,60.2,49.6,-11.2,-17.7],["MLB","BRDF01",93.6,92,82.5,-11.9,-10.4],["MLB","BRMG01",63.9,68.5,84.7,32.5,23.6],["MLB","BRMG02",163.8,226.2,150.8,-7.9,-33.3],["MLB","BRMG03",57.4,46.4,52.1,-9.2,12.4],["MLB","BRMG04",0,null,19.8,null,null],["MLB","BRPE01",134.5,115.6,131.8,-2,13.9],["MLB","BRPR01",51.4,61.1,99.4,93.4,62.6],["MLB","BRRC01",141.2,166.1,132.1,-6.5,-20.5],["MLB","BRRC02",29.3,41.6,69.4,136.9,66.7],["MLB","BRRC03",51.4,58.6,62.3,21.2,6.3],["MLB","BRRJ02",151.1,124.8,151,-0.1,20.9],["MLB","BRRS01",139.9,126.3,135.8,-2.9,7.5],["MLB","BRSC02",127.6,117.1,122.6,-4,4.7],["MLB","BRSP02",86.1,92.2,98.7,14.6,7.1],["MLB","BRSP04",236.9,211.4,258,8.9,22],["MLB","BRSP06",174.3,161,181.3,4,12.6],["MLB","BRSP09",143.2,430.2,295.2,106.2,-31.4],["MLB","BRSP10",110.9,78.4,79,-28.7,0.8],["MLB","BRSP11",122.5,59.3,122.2,-0.3,106.1],["MLB","BRSP14",217.9,201.9,200.8,-7.8,-0.5],["MLB","BRSP15",198.7,158,203.7,2.5,28.9],["MLB","BRSP18",176.8,171.4,193.6,9.5,12.9],["MLB","BRSP19",168.2,160.9,204,21.3,26.8],["MLB","BRSP24",43.8,64.5,113.3,158.8,75.7],["MLB","BRSP25",45,102.9,145.4,223.1,41.3],["MLB","CAMPINAS",null,0,null,null,null],["MLC","CLBB01",37.6,44.3,67.6,79.6,52.4],["MLC","CLRM03",165.8,172,196.5,18.6,14.2],["MLM","MXCD02",162.5,134.2,189.5,16.6,41.2],["MLM","MXCD05",53.4,47.6,55.1,3.3,15.9],["MLM","MXCD06",189.1,186.4,242.9,28.5,30.4],["MLM","MXCD07",229,173,214.5,-6.3,24],["MLM","MXCD08",45.2,84.6,99.2,119.5,17.2],["MLM","MXCD09",92.7,68.9,94.5,1.9,37.1],["MLM","MXCD10",281.3,248.6,339.2,20.6,36.4],["MLM","MXCD11",110.6,88.7,115,4,29.7],["MLM","MXCD12",59.7,54.6,69.2,15.9,26.6],["MLM","MXCD14",null,null,0.8,null,null],["MLM","MXGT01",161.9,146.4,152.4,-5.9,4.1],["MLM","MXJC01",254.6,232.3,281.9,10.7,21.4],["MLM","MXNL01",187.9,174,206.1,9.7,18.5],["MLM","MXRC03",161.1,112.1,137.2,-14.9,22.3],["MLM","MXRC04",108.8,null,null,null,null],["MLM","MXSO01",36.3,79.5,87.7,141.4,10.4],["MLM","MXYU01",168.8,141.3,157.5,-6.7,11.5],["MLM","USTX01",130.7,145.6,118.8,-9.2,-18.4]];
    // Share Retiros % = 100*Withdrawals/(Withdrawals+Disposal) packing. Fuente: RETURNS_NP_OUT (query_share_retiros.sql). Antes 9-dic: solo withdrawals → 100%.
    var datosShareFC = [["MCO","COCU02",100,95.3,94.7,-5.3,-0.7],["MLA","ARBA01",100,93.5,89.4,-10.6,-4.4],["MLA","ARBA02",100,100,100,0,0],["MLA","ARBA04",100,100,91.8,-8.2,-8.2],["MLB","BRBA01",100,79.5,64.9,-35.1,-18.3],["MLB","BRBA02",100,100,60.6,-39.4,-39.4],["MLB","BRDF01",100,69.5,100,0,43.9],["MLB","BRMG01",100,56.4,59.1,-40.9,4.8],["MLB","BRMG02",100,86.7,76.3,-23.7,-12],["MLB","BRMG03",100,52.2,60.8,-39.2,16.6],["MLB","BRMG04",null,0,0,null,null],["MLB","BRPE01",100,80.2,69.5,-30.5,-13.4],["MLB","BRPR01",100,87.7,68.9,-31.1,-21.4],["MLB","BRRC01",100,83.8,80.3,-19.7,-4.3],["MLB","BRRC02",100,79.6,70.7,-29.3,-11.1],["MLB","BRRC03",100,92.8,91.4,-8.6,-1.5],["MLB","BRRJ02",100,73.1,74,-26,1.2],["MLB","BRRS01",100,100,71,-29,-29],["MLB","BRSC02",100,78,74.5,-25.5,-4.5],["MLB","BRSP02",100,65.3,79,-21,21],["MLB","BRSP04",100,83,64,-36,-22.8],["MLB","BRSP06",100,68.6,60.7,-39.3,-11.5],["MLB","BRSP09",100,23.1,0,-100,-100],["MLB","BRSP10",100,83.3,58.9,-41.1,-29.3],["MLB","BRSP11",100,88.4,60.6,-39.4,-31.4],["MLB","BRSP14",100,87.2,77.9,-22.1,-10.7],["MLB","BRSP15",100,81.3,90.5,-9.5,11.4],["MLB","BRSP18",100,85.9,73.1,-26.9,-14.9],["MLB","BRSP19",100,88.5,74.6,-25.4,-15.8],["MLB","BRSP24",100,100,62.9,-37.1,-37.1],["MLB","BRSP25",100,85.4,71.1,-28.9,-16.7],["MLC","CLBB01",100,100,100,0,0],["MLC","CLRM03",100,75.2,83.1,-16.9,10.5],["MLM","MXCD02",100,58.1,61,-39,5.1],["MLM","MXCD05",100,87,70.6,-29.4,-18.9],["MLM","MXCD06",100,80.5,73.7,-26.3,-8.5],["MLM","MXCD07",100,73.2,69.5,-30.5,-5.1],["MLM","MXCD08",100,58.5,90.1,-9.9,54.1],["MLM","MXCD09",100,70.6,57.6,-42.4,-18.4],["MLM","MXCD10",100,64.6,56.7,-43.3,-12.3],["MLM","MXCD11",100,67.7,71.2,-28.8,5.2],["MLM","MXCD12",100,91,63.2,-36.8,-30.5],["MLM","MXCD14",null,null,100,null,null],["MLM","MXGT01",100,63.6,68.3,-31.7,7.4],["MLM","MXJC01",100,82.1,68.7,-31.3,-16.3],["MLM","MXNL01",100,69.1,69.1,-30.9,0.1],["MLM","MXRC03",100,54.1,41.3,-58.7,-23.6],["MLM","MXRC04",100,null,null,null,null],["MLM","MXSO01",100,100,75.8,-24.2,-24.2],["MLM","MXYU01",100,76.6,68.5,-31.5,-10.6],["MLM","USTX01",100,48,73.2,-26.8,52.7]];
    // Piezas por Tote = SUM(UNIT_QTY_PICKED)/SUM(TOTES_PER_CART_USED). Filtro: PROCESS_PATH_CODE IN (PP_WITHDRAWAL_SINGLE_SKU, PP_WITHDRAWAL_DIRECT_PACKING, PP_WITHDRAWAL_SORT). Fuente: WHOWNER.LK_SOT_PICKING_MAIN_TABLE.
    var datosToteFC = [["MCO","COCU02",8.4,6.9,4.1,-50.7,-39.7],["MLA","ARBA01",5.5,7.8,6.5,16.6,-16.7],["MLA","ARBA02",2,5.3,2.6,32.4,-50],["MLA","ARBA04",2.4,4,3.4,43.3,-15.6],["MLB","BRBA01",4.9,4.3,5.1,4.5,19],["MLB","BRBA02",2.4,2.8,4.2,75.2,51.1],["MLB","BRDF01",2.4,2.6,4.2,72.3,62.3],["MLB","BRMG01",6.7,4.5,9.1,35.5,101.5],["MLB","BRMG02",9.3,24.2,15.3,64.6,-36.7],["MLB","BRMG03",13.3,1.6,9,-32.3,472.7],["MLB","BRPE01",3.5,3.3,4.3,23.2,31.6],["MLB","BRPR01",1.9,2.5,2.8,43.4,10.6],["MLB","BRRC01",11.5,8.4,11.5,0.4,37.3],["MLB","BRRC02",6.3,6.3,7.6,20.5,21.6],["MLB","BRRC03",11.2,12.3,16.9,50.9,38.2],["MLB","BRRJ02",4.4,3.9,4.8,7.8,21.5],["MLB","BRRS01",3.1,3.2,4.1,33.7,27],["MLB","BRSC02",7.4,5.6,4.9,-33,-12],["MLB","BRSP02",4.1,2.4,3.9,-6.9,57.9],["MLB","BRSP04",5.5,5.5,5.4,-1.9,-1],["MLB","BRSP06",15.6,16.2,22.6,44.8,39.7],["MLB","BRSP10",5.1,4.8,5,-1.9,6.1],["MLB","BRSP11",8.4,10.8,10.2,21,-5.5],["MLB","BRSP14",3.7,3.9,4.9,34.9,28],["MLB","BRSP15",3.7,3.5,4.3,18.4,22.8],["MLB","BRSP18",6.9,5.8,5.6,-18.7,-2.6],["MLB","BRSP19",6.7,6,6.2,-7.1,3.6],["MLB","BRSP24",2.4,2.4,3.6,49.7,46.8],["MLB","BRSP25",7,6.5,5.8,-16.3,-10],["MLC","CLBB01",1.3,1.4,1.5,18.2,6],["MLC","CLRM03",6.1,5,9,47.6,81.1],["MLM","MXCD02",6.2,6.4,7,12.4,9.7],["MLM","MXCD05",4.3,3.9,3.3,-23.7,-16.1],["MLM","MXCD06",22.4,18.7,15.2,-32.2,-18.7],["MLM","MXCD07",4.6,3.9,6,29.6,52.5],["MLM","MXCD08",3.3,3.2,5.3,61.6,69.7],["MLM","MXCD09",3.3,2.9,3.7,10.4,28.6],["MLM","MXCD10",5.9,5.7,6.8,13.8,18.8],["MLM","MXCD11",5.1,5,4.8,-4.8,-3],["MLM","MXCD12",6.4,5.8,5.7,-9.8,-2],["MLM","MXCD14",null,null,5.4,null,null],["MLM","MXGT01",4.5,4.6,5.6,25.2,20.8],["MLM","MXJC01",5.3,5.7,5.8,10,1.2],["MLM","MXNL01",7.4,7,8.2,10.9,16.9],["MLM","MXRC03",9.8,11,8,-18.5,-27.3],["MLM","MXSO01",2.2,2.5,4.2,87.8,66.3],["MLM","MXYU01",3.9,4.9,4.9,27.5,0.2]];
    var resumenSite = { MLB: { picking: 55.4, packing: 133.2, tote: 5.4, share: 71.7 }, MLM: { picking: 69.1, packing: 158.7, tote: 6.4, share: 61.5 }, MLA: { picking: 50.2, packing: 88.1, tote: 6.4, share: 89.3 }, MLC: { picking: 96.8, packing: 196.3, tote: 8.8, share: 83.4 }, MCO: { picking: 103.1, packing: 148.7, tote: 4.1, share: 94.7 }, Total: { picking: 61.4, packing: 140.2, tote: 6, share: 69.4 } };
    var resumenSiteFull = { MLB: { picking: [47.1,52.6,55.4], packing: [120.5,119.5,133.2], tote: [5.4,4.9,5.4], share: [100,74.9,71.7] }, MLM: { picking: [61.6,57,69.1], packing: [147.5,121.9,158.7], tote: [5.5,5.4,6.4], share: [100,66.7,61.5] }, MLA: { picking: [56.4,58.3,50.2], packing: [101.8,101.4,88.1], tote: [5.5,7.7,6.4], share: [100,93.5,89.3] }, MLC: { picking: [91.1,85.9,96.8], packing: [165.5,171.5,196.3], tote: [6,4.8,8.8], share: [100,75.2,83.4] }, MCO: { picking: [110.2,113.4,103.1], packing: [189.1,171.7,148.7], tote: [8.4,6.9,4.1], share: [100,95.3,94.7] }, Total: { picking: [53.8,56,61.4], packing: [130.1,120.9,140.2], tote: [5.5,5.2,6], share: [100,72.9,69.4] } };
    var SITES_ORDER = ['MLB','MLM','MLA','MLC','MCO','Total'];
    var MESES_CORTOS = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    function fechaFinPostLabel() {
      var d = new Date();
      return d.getDate() + ' ' + MESES_CORTOS[d.getMonth()] + ' ' + d.getFullYear();
    }
    function fmt(v) { return v == null || v === '' ? '—' : Number(v).toLocaleString('es-AR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }); }
    function fmtPct(v) { return v == null || v === '' ? '—' : fmt(v) + '%'; }
    function deltaClass(d) { if (d == null || d === '') return ''; return Number(d) >= 0 ? 'delta-pos' : 'delta-neg'; }
    function filtrarPorSiteYFC(arr, siteFilter, fcFilter) {
      if (!siteFilter && !fcFilter) return arr;
      return arr.filter(function(r) {
        var okSite = !siteFilter || r[0] === siteFilter;
        var okFC = !fcFilter || r[1] === fcFilter;
        return okSite && okFC;
      });
    }
    function buscarValorFC(arr, site, fc, indiceP3) {
      var r = arr.find(function(x) { return x[0] === site && x[1] === fc; });
      return r ? r[indiceP3] : null;
    }
    function valorParaAnio(arr, anio, idxP1, idxP2, idxP3) {
      if (anio === '2025') { var p1 = arr[idxP1], p2 = arr[idxP2]; return (p1 != null && p2 != null) ? (p1 + p2) / 2 : (p2 != null ? p2 : p1); }
      return arr[idxP3];
    }
    function updateKpiCards(siteFilter, fcFilter, anio) {
      anio = anio || (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      var scope = '';
      var picking, packing, tote, share;
      if (fcFilter) {
        var todos = datosPickingFC.concat(datosPackingFC).concat(datosToteFC).concat(datosShareFC);
        var s = siteFilter || (function() { for (var i = 0; i < todos.length; i++) if (todos[i][1] === fcFilter) return todos[i][0]; return ''; })();
        scope = ' · ' + (s || '') + ' ' + fcFilter;
        var rPick = datosPickingFC.find(function(x) { return x[0] === s && x[1] === fcFilter; });
        var rPack = datosPackingFC.find(function(x) { return x[0] === s && x[1] === fcFilter; });
        var rTote = datosToteFC.find(function(x) { return x[0] === s && x[1] === fcFilter; });
        var rShare = datosShareFC.find(function(x) { return x[0] === s && x[1] === fcFilter; });
        picking = rPick ? valorParaAnio(rPick, anio, 2, 3, 4) : null;
        packing = rPack ? valorParaAnio(rPack, anio, 2, 3, 4) : null;
        tote = rTote ? valorParaAnio(rTote, anio, 2, 3, 4) : null;
        share = rShare ? valorParaAnio(rShare, anio, 2, 3, 4) : null;
      } else {
        var siteKey = siteFilter || 'Total';
        scope = siteFilter ? ' · ' + siteFilter : ' · Total';
        var R = resumenSiteFull[siteKey] || resumenSiteFull.Total;
        picking = R ? valorParaAnio(R.picking, anio, 0, 1, 2) : null;
        packing = R ? valorParaAnio(R.packing, anio, 0, 1, 2) : null;
        tote = R ? valorParaAnio(R.tote, anio, 0, 1, 2) : null;
        share = R ? valorParaAnio(R.share, anio, 0, 1, 2) : null;
      }
      document.getElementById('kpi-picking').textContent = picking != null ? fmt(picking) : '—';
      document.getElementById('kpi-packing').textContent = packing != null ? fmt(packing) : '—';
      document.getElementById('kpi-tote').textContent = tote != null ? fmt(tote) : '—';
      document.getElementById('kpi-share').textContent = share != null ? fmt(share) + '%' : '—';
      document.getElementById('kpi-picking-label').textContent = 'Productividad efectiva (Picking)' + scope + ' · ' + anio;
      document.getElementById('kpi-packing-label').textContent = 'Productividad efectiva (Packing)' + scope + ' · ' + anio;
      document.getElementById('kpi-tote-label').textContent = 'Piezas por Tote (#unidades/#totes)' + scope + ' · ' + anio;
      document.getElementById('kpi-share-label').textContent = 'Share Retiros' + scope + ' · ' + anio;
    }
    function renderResumenTable(anio, siteFilter) {
      anio = anio || (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      siteFilter = siteFilter || '';
      var thead = document.getElementById('tabla-kpis-thead');
      var tbody = document.getElementById('tabla-kpis-body');
      var sites = siteFilter ? SITES_ORDER.filter(function(s) { return s === siteFilter || s === 'Total'; }) : SITES_ORDER.slice();
      var headerHtml, fila = function(site, kpi, vals, esPct) {
        var trClass = (site === 'Total') ? ' class="total-row"' : '';
        var v0 = esPct ? fmtPct(vals[0]) : fmt(vals[0]), v1 = esPct ? fmtPct(vals[1]) : fmt(vals[1]), v2 = esPct ? fmtPct(vals[2]) : fmt(vals[2]);
        var d21 = vals[0] != null && vals[1] != null ? (vals[1] - vals[0]) / vals[0] * 100 : null;
        var d32 = vals[1] != null && vals[2] != null ? (vals[2] - vals[1]) / vals[1] * 100 : null;
        var d31 = vals[0] != null && vals[2] != null ? (vals[2] - vals[0]) / vals[0] * 100 : null;
        if (anio === '2025') return '<tr' + trClass + '><td>' + site + '</td><td class="num">' + v0 + '</td><td class="num">' + v1 + '</td><td class="num delta-col ' + deltaClass(d21) + '">' + (d21 != null ? fmt(d21) + '%' : '—') + '</td></tr>';
        if (anio === '2026') return '<tr' + trClass + '><td>' + site + '</td><td class="num">' + v2 + '</td></tr>';
        return '<tr' + trClass + '><td>' + site + '</td><td class="num">' + v0 + '</td><td class="num">' + v1 + '</td><td class="num">' + v2 + '</td><td class="num delta-col ' + deltaClass(d31) + '">' + (d31 != null ? fmt(d31) + '%' : '—') + '</td><td class="num delta-col ' + deltaClass(d32) + '">' + (d32 != null ? fmt(d32) + '%' : '—') + '</td></tr>';
      };
      if (anio === '2025') headerHtml = '<tr><th>Site</th><th class="num th-period">Pre-implemen<br>(01 Oct - 30 Nov 2025)</th><th class="num th-period">Pre-implemen<br>(01-31 Dic 2025)</th><th class="num delta-col">Delta Dic vs Oct+Nov</th></tr>';
      else if (anio === '2026') headerHtml = '<tr><th>Site</th><th class="num th-period">Post-implemen<br>(19 Ene - ' + fechaFinPostLabel() + ')</th></tr>';
      else headerHtml = '<tr><th>Site</th><th class="num th-period">Pre-implemen<br>(01 Oct - 30 Nov 2025)</th><th class="num th-period">Pre-implemen<br>(01-31 Dic 2025)</th><th class="num th-period">Post-implemen<br>(19 Ene - ' + fechaFinPostLabel() + ')</th><th class="num delta-col">Delta vs Oct+Nov</th><th class="num delta-col">Delta vs Dic</th></tr>';
      thead.innerHTML = headerHtml;
      var html = '';
      ['picking','packing','tote','share'].forEach(function(kpiName, idx) {
        var nombres = { picking: 'Productividad efectiva (Picking)', packing: 'Productividad efectiva (Packing)', tote: 'Piezas por Tote', share: 'Share Retiros' };
        var esPct = kpiName === 'share';
        var colSpan = anio === '2025' ? 4 : anio === '2026' ? 2 : 6;
        html += '<tr class="kpi-group"><td colspan="' + colSpan + '">' + nombres[kpiName] + '</td></tr>';
        for (var i = 0; i < sites.length; i++) {
          var s = sites[i], R = resumenSiteFull[s];
          if (!R) continue;
          html += fila(s, kpiName, R[kpiName], esPct);
        }
      });
      tbody.innerHTML = html;
    }
    function renderTablaFC(siteFilter, fcFilter, anio) {
      anio = anio || (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      siteFilter = siteFilter || '';
      fcFilter = fcFilter || '';
      var pick = filtrarPorSiteYFC(datosPickingFC, siteFilter, fcFilter);
      var pack = filtrarPorSiteYFC(datosPackingFC, siteFilter, fcFilter);
      var tote = filtrarPorSiteYFC(datosToteFC, siteFilter, fcFilter);
      var share = filtrarPorSiteYFC(datosShareFC, siteFilter, fcFilter);
      var thead = document.getElementById('tabla-fc-thead');
      var tbody = document.getElementById('tabla-fc-body');
      var nCol = anio === '2025' ? 5 : anio === '2026' ? 3 : 7;
      var labelPost = '19 Ene - ' + fechaFinPostLabel();
      var headerRowFC = anio === '2025' ? '<tr class="row-header"><th>Site</th><th>FC</th><th class="num th-period">Pre-implemen<br>(01 Oct - 30 Nov 2025)</th><th class="num th-period">Pre-implemen<br>(01-31 Dic 2025)</th><th class="num delta-col">Delta Dic vs Oct+Nov</th></tr>' : anio === '2026' ? '<tr class="row-header"><th>Site</th><th>FC</th><th class="num th-period">Post-implemen<br>(' + labelPost + ')</th></tr>' : '<tr class="row-header"><th>Site</th><th>FC</th><th class="num th-period">Pre-implemen<br>(01 Oct - 30 Nov 2025)</th><th class="num th-period">Pre-implemen<br>(01-31 Dic 2025)</th><th class="num th-period">Post-implemen<br>(' + labelPost + ')</th><th class="num delta-col">Delta vs Oct+Nov</th><th class="num delta-col">Delta vs Dic</th></tr>';
      function filas(data, esPct) {
        var out = '';
        for (var i = 0; i < data.length; i++) {
          var r = data[i], site = r[0], fc = r[1], p1 = r[2], p2 = r[3], p3 = r[4], d1 = r[5], d2 = r[6];
          var v1 = esPct ? fmtPct(p1) : fmt(p1), v2 = esPct ? fmtPct(p2) : fmt(p2), v3 = esPct ? fmtPct(p3) : fmt(p3);
          var d21 = (p1 != null && p2 != null) ? (p2 - p1) / p1 * 100 : null;
          if (anio === '2025') { out += '<tr><td>' + site + '</td><td>' + fc + '</td><td class="num">' + v1 + '</td><td class="num">' + v2 + '</td><td class="num delta-col ' + deltaClass(d21) + '">' + (d21 != null ? fmt(d21) + '%' : '—') + '</td></tr>'; continue; }
          if (anio === '2026') { out += '<tr><td>' + site + '</td><td>' + fc + '</td><td class="num">' + v3 + '</td></tr>'; continue; }
          var dd1 = d1 != null ? fmt(d1) + '%' : '—', dd2 = d2 != null ? fmt(d2) + '%' : '—';
          out += '<tr><td>' + site + '</td><td>' + fc + '</td><td class="num">' + v1 + '</td><td class="num">' + v2 + '</td><td class="num">' + v3 + '</td><td class="num ' + deltaClass(d1) + '">' + dd1 + '</td><td class="num ' + deltaClass(d2) + '">' + dd2 + '</td></tr>';
        }
        return out;
      }
      var html = '';
      html += '<tr class="kpi-group"><td colspan="' + nCol + '">Productividad efectiva (Picking) · por FC</td></tr>' + filas(pick, false);
      html += (anio === '2025' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">53,8</td><td class="num">56</td><td class="num">—</td></tr>' : anio === '2026' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">61,4</td></tr>' : '<tr class="total-row"><td>Total</td><td>—</td><td class="num">53,8</td><td class="num">56</td><td class="num">61,4</td><td class="num delta-pos">14,1%</td><td class="num delta-pos">9,6%</td></tr>');
      html += headerRowFC + '<tr class="kpi-group"><td colspan="' + nCol + '">Productividad efectiva (Packing) · por FC</td></tr>' + filas(pack, false);
      html += (anio === '2025' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">130,1</td><td class="num">120,9</td><td class="num">—</td></tr>' : anio === '2026' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">140,2</td></tr>' : '<tr class="total-row"><td>Total</td><td>—</td><td class="num">130,1</td><td class="num">120,9</td><td class="num">140,2</td><td class="num delta-pos">7,8%</td><td class="num delta-pos">16,0%</td></tr>');
      html += headerRowFC + '<tr class="kpi-group"><td colspan="' + nCol + '">Piezas por Tote (#unidades/#totes)</td></tr>' + filas(tote, false);
      html += (anio === '2025' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">5,5</td><td class="num">5,2</td><td class="num">—</td></tr>' : anio === '2026' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">6</td></tr>' : '<tr class="total-row"><td>Total</td><td>—</td><td class="num">5,5</td><td class="num">5,2</td><td class="num">6</td><td class="num delta-pos">9,1%</td><td class="num delta-pos">15,4%</td></tr>');
      html += headerRowFC + '<tr class="kpi-group"><td colspan="' + nCol + '">Share Retiros · por FC</td></tr>' + filas(share, true);
      html += (anio === '2025' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">68,9%</td><td class="num">63,7%</td><td class="num">—</td></tr>' : anio === '2026' ? '<tr class="total-row"><td>Total</td><td>—</td><td class="num">35,4%</td></tr>' : '<tr class="total-row"><td>Total</td><td>—</td><td class="num">68,9%</td><td class="num">63,7%</td><td class="num">35,4%</td><td class="num delta-neg">-48,7%</td><td class="num delta-neg">-44,5%</td></tr>');
      thead.innerHTML = headerRowFC;
      tbody.innerHTML = html;
    }
    function aplicarFiltros() {
      var anio = (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      var site = document.getElementById('site').value;
      var fc = document.getElementById('fc').value;
      var todosLosFC = datosPickingFC.concat(datosPackingFC).concat(datosToteFC).concat(datosShareFC);
      var sitioDelFC = null;
      if (fc) { for (var k = 0; k < todosLosFC.length; k++) { if (todosLosFC[k][1] === fc) { sitioDelFC = todosLosFC[k][0]; break; } } }
      var siteParaResumen = site || sitioDelFC;
      updateKpiCards(site, fc, anio);
      renderResumenTable(anio, siteParaResumen);
      renderTablaFC(site, fc, anio);
    }
    function llenarFiltroFC(siteFilter) {
      var todos = datosPickingFC.concat(datosPackingFC).concat(datosToteFC).concat(datosShareFC);
      var unicos = {};
      for (var i = 0; i < todos.length; i++) {
        var s = todos[i][0], f = todos[i][1];
        if (siteFilter && s !== siteFilter) continue;
        if (!unicos[f]) unicos[f] = s;
      }
      var fcs = Object.keys(unicos).sort();
      var sel = document.getElementById('fc');
      var valorActual = sel.value;
      sel.innerHTML = '<option value="">Todos</option>';
      for (var j = 0; j < fcs.length; j++) {
        var opt = document.createElement('option');
        opt.value = fcs[j];
        opt.textContent = fcs[j];
        sel.appendChild(opt);
      }
      if (valorActual && fcs.indexOf(valorActual) !== -1) sel.value = valorActual;
    }
    function fechaHoy() {
      var d = new Date();
      return ('0' + d.getDate()).slice(-2) + '/' + ('0' + (d.getMonth() + 1)).slice(-2) + '/' + d.getFullYear();
    }
    document.addEventListener('DOMContentLoaded', function() {
      var hoy = fechaHoy();
      var elNota = document.getElementById('fecha-hoy-nota');
      var elFooter = document.getElementById('fecha-hoy-footer');
      if (elNota) elNota.textContent = hoy;
      if (elFooter) elFooter.textContent = hoy;
      var anio = (document.getElementById('anio') && document.getElementById('anio').value) || 'Todos';
      llenarFiltroFC('');
      renderResumenTable(anio, '');
      renderTablaFC('', '', anio);
      updateKpiCards('', '', anio);
      document.getElementById('anio').addEventListener('change', aplicarFiltros);
      document.getElementById('site').addEventListener('change', function() { llenarFiltroFC(this.value); aplicarFiltros(); });
      document.getElementById('fc').addEventListener('change', aplicarFiltros);
    });
    function descargarCSV() {
      var table = document.getElementById('tabla-kpis');
      var rows = table.querySelectorAll('tr');
      var csv = [];
      for (var i = 0; i < rows.length; i++) {
        var cells = rows[i].querySelectorAll('th, td');
        var row = [];
        for (var j = 0; j < cells.length; j++) row.push('"' + (cells[j].textContent || '').trim().replace(/"/g, '""') + '"');
        csv.push(row.join(','));
      }
      var table2 = document.getElementById('tabla-fc');
      if (table2) {
        var rows2 = table2.querySelectorAll('tr');
        for (var i = 0; i < rows2.length; i++) {
          var cells = rows2[i].querySelectorAll('th, td');
          var row = [];
          for (var j = 0; j < cells.length; j++) row.push('"' + (cells[j].textContent || '').trim().replace(/"/g, '""') + '"');
          csv.push(row.join(','));
        }
      }
      var blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'kpis_pre_post_centralizacion_' + new Date().toISOString().slice(0,10) + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }
  </script>
</body>
</html>
